name: CD Pipeline - Deploy to AWS

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno a desplegar'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production

jobs:
  # Job para desplegar funciones Lambda/Serverless
  deploy-serverless:
    name: Deploy AWS Lambda & API Gateway
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Install Serverless Framework
        run: npm install -g serverless@3

      - name: Install dependencies
        working-directory: ./aws
        run: npm ci --production

      - name: Deploy to AWS
        working-directory: ./aws
        env:
          STAGE: ${{ github.event.inputs.environment || 'dev' }}
        run: |
          echo "üöÄ Deploying to stage: $STAGE"
          serverless deploy --stage $STAGE --region us-east-1 --verbose

      - name: Get deployment info
        working-directory: ./aws
        env:
          STAGE: ${{ github.event.inputs.environment || 'dev' }}
        run: serverless info --stage $STAGE --region us-east-1

      - name: Health Check
        working-directory: ./aws
        env:
          STAGE: ${{ github.event.inputs.environment || 'dev' }}
        run: |
          echo "‚è≥ Waiting for API to be ready..."
          sleep 15
          API_URL=$(serverless info --stage $STAGE | grep "HttpApiUrl" | awk '{print $2}')
          echo "Testing API at: $API_URL/health"
          curl -f "$API_URL/health" || echo "‚ö†Ô∏è Health endpoint not responding yet"

      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ Deployment to ${{ github.event.inputs.environment || 'dev' }} successful!"
          echo "üîç Check AWS CloudWatch Logs for Lambda execution"

  # Job para desplegar aplicaci√≥n Node.js en EC2 (Frontend) - DESHABILITADO
  # Habilitar cuando tengas EC2 configurado y secrets: EC2_HOST_STAGING, EC2_USER, EC2_SSH_KEY_STAGING
  # deploy-frontend:
  #   name: Deploy Frontend to EC2
  #   runs-on: ubuntu-latest
  #   needs: deploy-serverless
  #   if: github.event.inputs.environment != 'dev'
  #   environment:
  #     name: ${{ github.event.inputs.environment || 'staging' }}
  #     url: http://${{ secrets.EC2_HOST_STAGING }}:3000
  #     name: ${{ github.event.inputs.environment || 'staging' }}
  #     url: http://${{ secrets.EC2_HOST_STAGING }}:3000
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     # ... resto del deployment a EC2 deshabilitado
  #     # Habilitar cuando tengas EC2 configurado
