name: CD Pipeline - Deploy to AWSname: CD Pipeline - Deploy to AWS



on:on:

  push:  push:

    branches: [main]    branches: [main]

  workflow_dispatch:  workflow_dispatch:

    inputs:    inputs:

      environment:      environment:

        description: 'Entorno a desplegar'        description: 'Entorno a desplegar'

        required: true        required: true

        default: 'dev'        default: 'dev'

        type: choice        type: choice

        options:        options:

          - dev          - dev

          - staging          - staging

          - production          - production



jobs:jobs:

  deploy-serverless:  # Job para desplegar funciones Lambda/Serverless

    name: Deploy AWS Lambda & API Gateway  deploy-serverless:

    runs-on: ubuntu-latest    name: Deploy AWS Lambda & API Gateway

    environment:    runs-on: ubuntu-latest

      name: ${{ github.event.inputs.environment || 'dev' }}    environment:

    steps:      name: ${{ github.event.inputs.environment || 'dev' }}

      - name: Checkout code    steps:

        uses: actions/checkout@v4      - name: Checkout code

        uses: actions/checkout@v4

      - name: Setup Node.js

        uses: actions/setup-node@v4      - name: Setup Node.js

        with:        uses: actions/setup-node@v4

          node-version: '20'        with:

          node-version: '20'

      - name: Configure AWS credentials

        uses: aws-actions/configure-aws-credentials@v4      - name: Configure AWS credentials

        with:        uses: aws-actions/configure-aws-credentials@v4

          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}        with:

          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}

          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

          aws-region: us-east-1          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}

          aws-region: us-east-1

      - name: Install dependencies

        working-directory: ./aws      - name: Install dependencies

        run: npm ci        working-directory: ./aws

        run: npm ci

      - name: Install Serverless Framework

        run: npm install -g serverless@3      - name: Install jq (for JSON parsing)

        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Deploy with Serverless Framework

        working-directory: ./aws      - name: Make scripts executable

        env:        working-directory: ./aws

          STAGE: ${{ github.event.inputs.environment || 'dev' }}        run: chmod +x scripts/*.sh

          AWS_REGION: us-east-1

          AWS_ROLE: arn:aws:iam::851725349092:role/LabRole      - name: List existing AWS resources

        run: |        run: |

          echo "üöÄ Deploying with Serverless Framework"          echo "ÔøΩ Checking existing AWS resources..."

          echo "   Stage: $STAGE"          echo ""

          echo "   Region: $AWS_REGION"          echo "DynamoDB Tables:"

          echo ""          aws dynamodb list-tables --region us-east-1 2>&1 || echo "‚ö†Ô∏è  Cannot list tables"

          serverless deploy --stage $STAGE --region $AWS_REGION --verbose          echo ""

          echo "Lambda Functions:"

      - name: Get deployment info          aws lambda list-functions --region us-east-1 --query 'Functions[*].FunctionName' 2>&1 || echo "‚ö†Ô∏è  Cannot list functions"

        working-directory: ./aws          echo ""

        env:          echo "Cognito User Pools:"

          STAGE: ${{ github.event.inputs.environment || 'dev' }}          aws cognito-idp list-user-pools --max-results 60 --region us-east-1 --query 'UserPools[*].Name' 2>&1 || echo "‚ö†Ô∏è  Cannot list pools"

        run: |

          echo "üìã Deployment Information:"      - name: Deploy Infrastructure

          serverless info --stage $STAGE --region us-east-1        working-directory: ./aws

        env:

      - name: Test Health Endpoint          STAGE: ${{ github.event.inputs.environment || 'dev' }}

        working-directory: ./aws          AWS_REGION: us-east-1

        env:        run: |

          STAGE: ${{ github.event.inputs.environment || 'dev' }}          echo "üöÄ Starting deployment to stage: $STAGE"

        run: |          echo ""

          echo "üè• Testing health endpoint..."          

          API_URL=$(serverless info --stage $STAGE --region us-east-1 | grep "HttpApiUrl" | awk '{print $2}')          # Intentar deployment completo, pero continuar si hay errores parciales

          if [ ! -z "$API_URL" ]; then          bash scripts/deploy-all.sh

            echo "API URL: $API_URL"          EXIT_CODE=$?

            sleep 10          

            curl -f "$API_URL/health" || echo "‚ö†Ô∏è Health check not responding yet"          if [ $EXIT_CODE -ne 0 ]; then

          else            echo "‚ö†Ô∏è  Full deployment had some issues, trying Lambda-only deployment..."

            echo "‚ö†Ô∏è Could not extract API URL"            bash scripts/deploy-lambda.sh || exit 1

          fi          fi

          

      - name: Notify Success          echo "‚úÖ Deployment process completed"

        if: success()

        run: |      - name: Get deployment info

          echo "‚úÖ Deployment to ${{ github.event.inputs.environment || 'dev' }} successful!"        working-directory: ./aws

          echo "üîç Check AWS Console for deployed resources"        env:

          STAGE: ${{ github.event.inputs.environment || 'dev' }}
        run: |
          echo "üìã Deployment Information:"
          echo ""
          echo "DynamoDB Tables:"
          aws dynamodb list-tables --region us-east-1 | jq -r '.TableNames[] | select(contains("hospital-backend-'$STAGE'"))'
          echo ""
          echo "Lambda Functions:"
          aws lambda list-functions --region us-east-1 | jq -r '.Functions[] | select(.FunctionName | contains("hospital-backend-'$STAGE'")) | .FunctionName'
          echo ""
          if [ -f .aws-output/cognito-ids.json ]; then
            echo "Cognito Configuration:"
            cat .aws-output/cognito-ids.json | jq .
          fi

      - name: Test Lambda Health Check
        working-directory: ./aws
        env:
          STAGE: ${{ github.event.inputs.environment || 'dev' }}
        run: |
          echo "üè• Testing health check function..."
          aws lambda invoke \
            --function-name hospital-backend-health-$STAGE \
            --region us-east-1 \
            --log-type Tail \
            response.json
          
          echo ""
          echo "Response:"
          cat response.json | jq .
          
          STATUS_CODE=$(cat response.json | jq -r '.statusCode // "error"')
          if [ "$STATUS_CODE" = "200" ]; then
            echo "‚úÖ Health check passed!"
          else
            echo "‚ö†Ô∏è Health check returned status: $STATUS_CODE"
          fi

      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ Deployment to ${{ github.event.inputs.environment || 'dev' }} successful!"
          echo "üîç Check AWS CloudWatch Logs for Lambda execution"

  # Job para desplegar aplicaci√≥n Node.js en EC2 (Frontend) - DESHABILITADO
  # Habilitar cuando tengas EC2 configurado y secrets: EC2_HOST_STAGING, EC2_USER, EC2_SSH_KEY_STAGING
  # deploy-frontend:
  #   name: Deploy Frontend to EC2
  #   runs-on: ubuntu-latest
  #   needs: deploy-serverless
  #   if: github.event.inputs.environment != 'dev'
  #   environment:
  #     name: ${{ github.event.inputs.environment || 'staging' }}
  #     url: http://${{ secrets.EC2_HOST_STAGING }}:3000
  #     name: ${{ github.event.inputs.environment || 'staging' }}
  #     url: http://${{ secrets.EC2_HOST_STAGING }}:3000
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     # ... resto del deployment a EC2 deshabilitado
  #     # Habilitar cuando tengas EC2 configurado
