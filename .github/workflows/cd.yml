name: CD Pipeline - Deploy to AWS

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno a desplegar'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production

jobs:
  deploy-serverless:
    name: Deploy AWS Lambda & API Gateway
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Install dependencies
        working-directory: ./aws
        run: npm ci

      - name: Install Serverless Framework
        run: npm install -g serverless@3

      - name: Deploy with Serverless Framework
        working-directory: ./aws
        env:
          STAGE: ${{ github.event.inputs.environment || 'dev' }}
          AWS_REGION: us-east-1
          AWS_ROLE: arn:aws:iam::851725349092:role/LabRole
        run: |
          echo "üöÄ Deploying with Serverless Framework"
          echo "   Stage: $STAGE"
          echo "   Region: $AWS_REGION"
          echo ""
          serverless deploy --stage $STAGE --region $AWS_REGION --verbose

      - name: Get deployment info
        working-directory: ./aws
        env:
          STAGE: ${{ github.event.inputs.environment || 'dev' }}
        run: |
          echo "üìã Deployment Information:"
          serverless info --stage $STAGE --region us-east-1

      - name: Test Health Endpoint
        working-directory: ./aws
        env:
          STAGE: ${{ github.event.inputs.environment || 'dev' }}
        run: |
          echo "üè• Testing health endpoint..."
          API_URL=$(serverless info --stage $STAGE --region us-east-1 | grep "HttpApiUrl" | awk '{print $2}')
          if [ ! -z "$API_URL" ]; then
            echo "API URL: $API_URL"
            sleep 10
            curl -f "$API_URL/health" || echo "‚ö†Ô∏è Health check not responding yet"
          else
            echo "‚ö†Ô∏è Could not extract API URL"
          fi

      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ Deployment to ${{ github.event.inputs.environment || 'dev' }} successful!"
          echo "üîç Check AWS Console for deployed resources"
