name: CD Pipeline - Deploy to AWS

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno a desplegar'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production

jobs:
  # Job para desplegar funciones Lambda/Serverless
  deploy-serverless:
    name: Deploy AWS Lambda & API Gateway
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Install dependencies
        working-directory: ./aws
        run: npm ci

      - name: Install jq (for JSON parsing)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Make scripts executable
        working-directory: ./aws
        run: chmod +x scripts/*.sh

      - name: List existing AWS resources
        run: |
          echo "ÔøΩ Checking existing AWS resources..."
          echo ""
          echo "DynamoDB Tables:"
          aws dynamodb list-tables --region us-east-1 2>&1 || echo "‚ö†Ô∏è  Cannot list tables"
          echo ""
          echo "Lambda Functions:"
          aws lambda list-functions --region us-east-1 --query 'Functions[*].FunctionName' 2>&1 || echo "‚ö†Ô∏è  Cannot list functions"
          echo ""
          echo "Cognito User Pools:"
          aws cognito-idp list-user-pools --max-results 60 --region us-east-1 --query 'UserPools[*].Name' 2>&1 || echo "‚ö†Ô∏è  Cannot list pools"

      - name: Deploy Infrastructure
        working-directory: ./aws
        env:
          STAGE: ${{ github.event.inputs.environment || 'dev' }}
          AWS_REGION: us-east-1
        run: |
          echo "üöÄ Starting deployment to stage: $STAGE"
          echo ""
          
          # Intentar deployment completo, pero continuar si hay errores parciales
          bash scripts/deploy-all.sh
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ö†Ô∏è  Full deployment had some issues, trying Lambda-only deployment..."
            bash scripts/deploy-lambda.sh || exit 1
          fi
          
          echo "‚úÖ Deployment process completed"

      - name: Get deployment info
        working-directory: ./aws
        env:
          STAGE: ${{ github.event.inputs.environment || 'dev' }}
        run: |
          echo "üìã Deployment Information:"
          echo ""
          echo "DynamoDB Tables:"
          aws dynamodb list-tables --region us-east-1 | jq -r '.TableNames[] | select(contains("hospital-backend-'$STAGE'"))'
          echo ""
          echo "Lambda Functions:"
          aws lambda list-functions --region us-east-1 | jq -r '.Functions[] | select(.FunctionName | contains("hospital-backend-'$STAGE'")) | .FunctionName'
          echo ""
          if [ -f .aws-output/cognito-ids.json ]; then
            echo "Cognito Configuration:"
            cat .aws-output/cognito-ids.json | jq .
          fi

      - name: Test Lambda Health Check
        working-directory: ./aws
        env:
          STAGE: ${{ github.event.inputs.environment || 'dev' }}
        run: |
          echo "üè• Testing health check function..."
          aws lambda invoke \
            --function-name hospital-backend-health-$STAGE \
            --region us-east-1 \
            --log-type Tail \
            response.json
          
          echo ""
          echo "Response:"
          cat response.json | jq .
          
          STATUS_CODE=$(cat response.json | jq -r '.statusCode // "error"')
          if [ "$STATUS_CODE" = "200" ]; then
            echo "‚úÖ Health check passed!"
          else
            echo "‚ö†Ô∏è Health check returned status: $STATUS_CODE"
          fi

      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ Deployment to ${{ github.event.inputs.environment || 'dev' }} successful!"
          echo "üîç Check AWS CloudWatch Logs for Lambda execution"

  # Job para desplegar aplicaci√≥n Node.js en EC2 (Frontend) - DESHABILITADO
  # Habilitar cuando tengas EC2 configurado y secrets: EC2_HOST_STAGING, EC2_USER, EC2_SSH_KEY_STAGING
  # deploy-frontend:
  #   name: Deploy Frontend to EC2
  #   runs-on: ubuntu-latest
  #   needs: deploy-serverless
  #   if: github.event.inputs.environment != 'dev'
  #   environment:
  #     name: ${{ github.event.inputs.environment || 'staging' }}
  #     url: http://${{ secrets.EC2_HOST_STAGING }}:3000
  #     name: ${{ github.event.inputs.environment || 'staging' }}
  #     url: http://${{ secrets.EC2_HOST_STAGING }}:3000
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     # ... resto del deployment a EC2 deshabilitado
  #     # Habilitar cuando tengas EC2 configurado
