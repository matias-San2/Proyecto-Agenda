service: aws-cognito-jwt-login
frameworkVersion: '3'

plugins:
  - serverless-scriptable-plugin

custom:
  brandingBucket: ${self:service}-${self:provider.stage}-assets
  scriptHooks:
    after:deploy:finalize: node scripts/run-seed.js

layers:
  AwsSdkV3Layer:
    path: layers/aws-sdk-v3
    name: ${self:service}-aws-sdk-v3
    compatibleRuntimes:
      - nodejs20.x

provider:
  name: aws
  runtime: nodejs20.x
  region: ${env:AWS_REGION, 'us-east-1'}
  stage: ${opt:stage, 'dev'}
  
  
  
  tags:
    Project: HospitalPadreHurtado
    Environment: ${sls:stage}
    ManagedBy: Serverless
    Version: 1.0.0
  
  environment:
    USER_POOL_ID: { Ref: CognitoUserPool }
    USER_POOL_CLIENT_ID: { Ref: CognitoUserPoolClient }
    USER_ROLES_TABLE: ${self:service}-${sls:stage}-user-roles
    PERMISSIONS_TABLE: ${self:service}-${sls:stage}-permissions
    PARAMETERS_TABLE: ${self:service}-${sls:stage}-parameters
    ACTIVITY_LOGS_TABLE: ${self:service}-${sls:stage}-activity-logs
    PERSONALIZATION_TOPIC_ARN: { Ref: PersonalizationTopic }
    SYSTEM_NOTIFICATIONS_TOPIC_ARN: { Ref: SystemNotificationsTopic }
    PROCESSED_MESSAGES_TABLE: ${self:service}-${sls:stage}-processed-messages
    SERVICE_NAME: ${self:service}
    DB_CATALOGO: ${self:service}-${sls:stage}-catalogo
    DB_AGENDA: ${self:service}-${sls:stage}-agenda
    DB_BOX_INSTRUMENTO: ${self:service}-${sls:stage}-box-instrumento
    DB_NOTIFICACION: ${self:service}-${sls:stage}-notificacion
    STAGE: ${sls:stage}
    BRANDING_BUCKET: ${self:service}-${self:provider.stage}-assets
    ROLES_BASE_TABLE: ${self:service}-${sls:stage}-roles-base
    
  logs:
    httpApi: true
    
  httpApi:
    cors:
      allowedOrigins:
        - '*'
      allowedHeaders:
        - Content-Type
        - Authorization
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowCredentials: false
    authorizers:
      cognitoJwt:
        type: jwt
        identitySource: $request.header.Authorization
        issuerUrl:
          Fn::Sub:
            - https://cognito-idp.${AWS::Region}.amazonaws.com/${UserPoolId}
            - UserPoolId: 
                Ref: CognitoUserPool
        audience:
          - Ref: CognitoUserPoolClient
  
  iamRoleStatements:
    - Effect: Allow
      Action:
        - sns:Publish
      Resource:
        - Ref: PersonalizationTopic
        - Ref: SystemNotificationsTopic
    
    - Effect: Allow
      Action:
        - dynamodb:PutItem
        - dynamodb:GetItem
        - dynamodb:Query
        - dynamodb:Scan
      Resource:
        - Fn::GetAtt: [ActivityLogsTable, Arn]
        - Fn::Sub: '${ActivityLogsTable.Arn}/index/*'
    
    - Effect: Allow
      Action:
        - dynamodb:PutItem
        - dynamodb:GetItem
        - dynamodb:Query
        - dynamodb:UpdateItem
      Resource:
        - Fn::GetAtt: [ParametersTable, Arn]
    
    - Effect: Allow
      Action:
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
        - dynamodb:Query
        - dynamodb:Scan
      Resource:
        - Fn::GetAtt: [UserRolesTable, Arn]
        - Fn::Sub: '${UserRolesTable.Arn}/index/*'
    
    - Effect: Allow
      Action:
        - dynamodb:GetItem
        - dynamodb:Query
        - dynamodb:Scan
      Resource:
        - Fn::GetAtt: [PermissionsTable, Arn]
    - Effect: Allow
      Action:
        - s3:PutObject
        - s3:GetObject
        - s3:DeleteObject
      Resource:
        - Fn::Sub: arn:aws:s3:::${self:service}-${self:provider.stage}-assets/*

    - Effect: Allow
      Action:
        - sqs:ReceiveMessage
        - sqs:DeleteMessage
        - sqs:GetQueueAttributes
        - sqs:ChangeMessageVisibility
      Resource:
        - Fn::GetAtt: [PersonalizationQueue, Arn]
        - Fn::GetAtt: [SystemNotificationsQueue, Arn]

    - Effect: Allow
      Action:
        - dynamodb:PutItem
        - dynamodb:GetItem
      Resource:
        - Fn::GetAtt: [ProcessedMessagesTable, Arn]
    
    - Effect: Allow
      Action:
        - lambda:InvokeFunction
      Resource:
        - Fn::Sub: 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${self:service}-${sls:stage}-*'
    
    - Effect: Allow
      Action:
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
        - dynamodb:Query
        - dynamodb:Scan
      Resource:
        - Fn::GetAtt: [CatalogoTable, Arn]
        - Fn::Sub: '${CatalogoTable.Arn}/index/*'
        - Fn::GetAtt: [AgendaTable, Arn]
        - Fn::Sub: '${AgendaTable.Arn}/index/*'
        - Fn::GetAtt: [BoxInstrumentoTable, Arn]
        - Fn::Sub: '${BoxInstrumentoTable.Arn}/index/*'
        - Fn::GetAtt: [NotificacionTable, Arn]
        - Fn::Sub: '${NotificacionTable.Arn}/index/*'

    - Effect: Allow
      Action:
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource:
        - Fn::GetAtt: [BaseRolesTable, Arn]

    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:DeleteItem
        - dynamodb:Scan
      Resource:
        - Fn::GetAtt: [UserRolesTable, Arn]
        - Fn::Sub: '${UserRolesTable.Arn}/index/*'
        - Fn::GetAtt: [ParametersTable, Arn]
        - Fn::Sub: '${ParametersTable.Arn}/index/*'

    - Effect: Allow
      Action:
        - cognito-idp:ListUsers
        - cognito-idp:AdminCreateUser
        - cognito-idp:AdminSetUserPassword
        - cognito-idp:AdminUpdateUserAttributes
        - cognito-idp:AdminGetUser
        - cognito-idp:AdminDeleteUser
      Resource:
        - Fn::Sub: arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${CognitoUserPool}

    - Effect: Allow
      Action:
        - s3:ListBucket
        - s3:DeleteObject
      Resource:
        - Fn::Sub: arn:aws:s3:::${self:service}-${self:provider.stage}-assets
        - Fn::Sub: arn:aws:s3:::${self:service}-${self:provider.stage}-assets/*

functions:
  # === HEALTH CHECK ===
  health:
    handler: src/handlers/health.check
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - httpApi:
          method: GET
          path: /health
    timeout: 10
    description: Health check endpoint for monitoring

  chaosTest:
    handler: src/handlers/chaos.run
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - httpApi:
          method: GET
          path: /chaos-test
    timeout: 10
    description: Chaos engineering endpoint to simulate failures

  simulateLatency:
    handler: src/handlers/chaos/latencyChaos.simulate
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - httpApi:
          method: GET
          path: /chaos-latency
    description: Simula una respuesta con retardo aleatorio

  # === FUNCIONES DE AUTENTICACIÓN ===
  login:
    handler: src/handlers/login/login.login
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - httpApi:
          method: POST
          path: /auth/login
    timeout: 30
    description: User authentication endpoint

  onboardingCreateAdmin:
    handler: src/handlers/admin/onboarding.createAdmin
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - httpApi:
          method: POST
          path: /admin/onboarding/create-admin
    timeout: 60
    description: Endpoint to create the initial admin user and company

  deleteTenant:
    handler: src/handlers/admin/deleteTenant.deleteTenant
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    description: Delete a tenant (empresa) and all associated data
    timeout: 30
    events:
      - httpApi:
          method: DELETE
          path: /admin/tenant/{empresaId}
          authorizer:
            name: cognitoJwt

  seedRoles:
    handler: src/handlers/admin/seedRoles.run
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    description: Seed global base roles into DynamoDB
    timeout: 20

  refresh:
    handler: src/handlers/login/refresh.refresh
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - httpApi:
          method: POST
          path: /auth/refresh
    timeout: 30
    description: Token refresh endpoint

  me:
    handler: src/handlers/login/me.me
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - httpApi:
          method: GET
          path: /me
          authorizer:
            name: cognitoJwt
    timeout: 10
    description: Get current user information

  # === FUNCIONES DE PERMISOS ===
  getMyPermissions:
    handler: src/handlers/permissions/permissions.getMyPermissions
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - httpApi:
          method: GET
          path: /my-permissions
          authorizer:
            name: cognitoJwt
    timeout: 10
    description: Get user permissions

  checkPermission:
    handler: src/handlers/permissions/permissions.checkPermission
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - httpApi:
          method: POST
          path: /check-permission
          authorizer:
            name: cognitoJwt
    timeout: 10
    description: Check specific permission

  assignRole:
    handler: src/handlers/permissions/permissions.assignRole
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - httpApi:
          method: POST
          path: /admin/assign-role
          authorizer:
            name: cognitoJwt
    timeout: 15
    description: Assign role to user (admin only)

  removeRole:
    handler: src/handlers/permissions/permissions.removeRole
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - httpApi:
          method: DELETE
          path: /admin/remove-role
          authorizer:
            name: cognitoJwt

  listAvailablePermissions:
    handler: src/handlers/permissions/permissions.listAvailablePermissions
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - httpApi:
          method: GET
          path: /admin/available-permissions
          authorizer:
            name: cognitoJwt
    timeout: 10
    description: List all available permissions

  listUsersWithRoles:
    handler: src/handlers/permissions/permissions.listUsersWithRoles
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - httpApi:
          method: GET
          path: /admin/users-with-roles
          authorizer:
            name: cognitoJwt

  # === FUNCIONES DE PERSONALIZACIÓN ===
  getPersonalization:
    handler: src/handlers/personalization/personalization.getPersonalization
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - httpApi:
          method: GET
          path: /personalization
          authorizer:
            name: cognitoJwt
    timeout: 10
    description: Get user personalization settings

  setPersonalization:
    handler: src/handlers/personalization/personalization.setPersonalization
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - httpApi:
          method: POST
          path: /personalization
          authorizer:
            name: cognitoJwt
  uploadBrandingAsset:
    handler: src/handlers/personalization/personalization.uploadBrandingAsset
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    timeout: 30
    description: Upload branding assets for a company
    events:
      - httpApi:
          method: POST
          path: /personalization/branding/upload
          authorizer:
            name: cognitoJwt
  
  # === FUNCIONES DE COMUNICACIÓN DESACOPLADA ===
  handlePersonalizationEvents:
    handler: src/handlers/events.handlePersonalizationEvents
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - sqs:
          arn:
            Fn::GetAtt: [PersonalizationQueue, Arn]
          batchSize: 5
          maximumBatchingWindow: 10

  handleSystemNotifications:
    handler: src/handlers/events.handleSystemNotifications
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - sqs:
          arn:
            Fn::GetAtt: [SystemNotificationsQueue, Arn]
          batchSize: 5
          maximumBatchingWindow: 10

  # === FUNCIONES DE LOGS ===
  getActivityLogs:
    handler: src/handlers/logs.getActivityLogs
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - httpApi:
          method: GET
          path: /admin/activity-logs
          authorizer:
            name: cognitoJwt

  getActivityStats:
    handler: src/handlers/logs.getActivityStats
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - httpApi:
          method: GET
          path: /admin/activity-stats
          authorizer:
            name: cognitoJwt
  
  # === FUNCIONES DB ===
  dbProxy:
    handler: src/handlers/dbProxy.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    events:
      - httpApi:
          path: /db/{proxy+}
          method: any
          authorizer:
            name: cognitoJwt
  
  obtenerPasillos:
    handler: src/handlers/db/obtenerPasillos.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }

  obtenerBoxes:
    handler: src/handlers/db/obtenerBoxes.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }

  obtenerAgendaPorFecha:
    handler: src/handlers/db/obtenerAgendaPorFecha.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }

  obtenerEspecialidades:
    handler: src/handlers/db/obtenerEspecialidades.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }

  obtenerMedicos:
    handler: src/handlers/db/obtenerMedicos.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }

  obtenerAgendaPorBox:
    handler: src/handlers/db/obtenerAgendaPorBox.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
  
  obtenerAgendaPorMedico:
    handler: src/handlers/db/obtenerAgendaPorMedico.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
  
  obtenerAgendaPorId:
    handler: src/handlers/db/obtenerAgendaPorId.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }

  verificarConflictoBox:
    handler: src/handlers/db/verificarConflictoBox.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
  
  verificarConflictoMedico:
    handler: src/handlers/db/verificarConflictoMedico.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
    
  obtenerEstadoNoAtendido:
    handler: src/handlers/db/obtenerEstadoNoAtendido.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
  
  insertarAgenda:
    handler: src/handlers/db/insertarAgenda.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }

  actualizarEstadoAgenda:
    handler: src/handlers/db/actualizarEstadoAgenda.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }

  obtenerInstrumentosPorBox:
    handler: src/handlers/db/obtenerInstrumentosPorBox.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }

  obtenerBoxYPasillo:
    handler: src/handlers/db/obtenerBoxYPasillo.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
  
  obtenerAgendaPorBoxYFecha:
    handler: src/handlers/db/obtenerAgendaPorBoxYFecha.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }

  obtenerNotificaciones:
    handler: src/handlers/db/obtenerNotificaciones.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }

  obtenerMedicoNombre:
    handler: src/handlers/db/obtenerMedicoNombre.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }

  obtenerTotalConsultas:
    handler: src/handlers/db/obtenerTotalConsultas.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
  
  obtenerBoxesDisponibles:
    handler: src/handlers/db/obtenerBoxesDisponibles.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
  
  obtenerEspecialidadMasDemandada:
    handler: src/handlers/db/obtenerEspecialidadMasDemandada.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }

  obtenerConsultasPorEspecialidad:
    handler: src/handlers/db/obtenerConsultasPorEspecialidad.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
  
  obtenerConsultasPorDia:
    handler: src/handlers/db/obtenerConsultasPorDia.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
  
  obtenerRendimientoMedicos:
    handler: src/handlers/db/obtenerRendimientoMedicos.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }

  obtenerMedicosPorEspecialidades:
    handler: src/handlers/db/obtenerMedicosPorEspecialidades.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
  
  obtenerConsultasEnCurso:
    handler: src/handlers/db/obtenerConsultasEnCurso.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }
  
  eliminarAgenda:
    handler: src/handlers/db/eliminarAgenda.handler
    layers:
      - { Ref: AwsSdkV3LayerLambdaLayer }

# Plugins comentados - no necesarios para deployment
# plugins:
#   - serverless-offline

package:
  individually: true
  patterns:
    - 'src/**'
    - 'package.json'
    - '!node_modules/**'
    - '!package-lock.json'
    - '!**/*.md'
    - '!test/**'
    - '!tests/**'
    - '!example/**'
    - '!examples/**'
    - '!docs/**'
    - '!coverage/**'
    - '!scripts/**'
    - '!*.test.js'
    - '!.git/**'
    - '!.github/**'
    - '!.vscode/**'


resources:
  Resources:
    # === DYNAMODB ===
    UserRolesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-user-roles
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: user_email
            AttributeType: S
          - AttributeName: role
            AttributeType: S
          - AttributeName: empresaId
            AttributeType: S
        KeySchema:
          - AttributeName: user_email
            KeyType: HASH
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        Tags:
          - Key: Environment
            Value: ${sls:stage}
          - Key: Project
            Value: HospitalPadreHurtado
        GlobalSecondaryIndexes:
          - IndexName: RoleIndex
            KeySchema:
              - AttributeName: role
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: empresaId-index
            KeySchema:
              - AttributeName: empresaId
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    BaseRolesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-roles-base
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: role_key
            AttributeType: S
          - AttributeName: role
            AttributeType: S
          - AttributeName: empresaId
            AttributeType: S
        KeySchema:
          - AttributeName: role_key
            KeyType: HASH
        Tags:
          - Key: Environment
            Value: ${sls:stage}
          - Key: Project
            Value: HospitalPadreHurtado
        GlobalSecondaryIndexes:
          - IndexName: RoleIndex
            KeySchema:
              - AttributeName: role
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: empresaId-index
            KeySchema:
              - AttributeName: empresaId
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    PermissionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-permissions
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: permission_id
            AttributeType: S
        KeySchema:
          - AttributeName: permission_id
            KeyType: HASH
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        Tags:
          - Key: Environment
            Value: ${sls:stage}
          - Key: Project
            Value: HospitalPadreHurtado
    
    ParametersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-parameters
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: user_sub
            AttributeType: S
          - AttributeName: parameter_key
            AttributeType: S
          - AttributeName: empresaId
            AttributeType: S
        KeySchema:
          - AttributeName: user_sub
            KeyType: HASH
          - AttributeName: parameter_key
            KeyType: RANGE
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        Tags:
          - Key: Environment
            Value: ${sls:stage}
          - Key: Project
            Value: HospitalPadreHurtado
        GlobalSecondaryIndexes:
          - IndexName: empresaId-index
            KeySchema:
              - AttributeName: empresaId
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    ActivityLogsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-activity-logs
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: user_sub
            AttributeType: S
          - AttributeName: timestamp
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: UserActivityIndex
            KeySchema:
              - AttributeName: user_sub
                KeyType: HASH
              - AttributeName: timestamp
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
    
    # === TABLA DE AGENDA ===
    AgendaTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-agenda
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
          - AttributeName: GSI2PK
            AttributeType: S
          - AttributeName: GSI2SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: MedicoFechaIndex
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: FechaIndex
            KeySchema:
              - AttributeName: GSI2PK
                KeyType: HASH
              - AttributeName: GSI2SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    # === TABLA DE CATÁLOGOS ===
    CatalogoTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-catalogo
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: TipoEntidadIndex
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    # === TABLA DE RELACIONES BOX-INSTRUMENTO ===
    BoxInstrumentoTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-box-instrumento
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: InstrumentoBoxIndex
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    # === TABLA DE NOTIFICACIONES ===
    NotificacionTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-notificacion
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: TipoFechaIndex
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
    
    # === TABLA DE IDEMPOTENCIA ===
    ProcessedMessagesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-processed-messages
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: message_id
            AttributeType: S
        KeySchema:
          - AttributeName: message_id
            KeyType: HASH
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true

    # === SQS PARA PERSONALIZACIÓN ===
    PersonalizationDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${sls:stage}-personalization-dlq
        MessageRetentionPeriod: 1209600 # 14 días

    PersonalizationQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${sls:stage}-personalization-queue
        VisibilityTimeout: 60
        RedrivePolicy:
          deadLetterTargetArn: 
            Fn::GetAtt: [PersonalizationDLQ, Arn]
          maxReceiveCount: 3

    # Permitir que SNS publique en la cola
    PersonalizationQueuePolicy:
      Type: AWS::SQS::QueuePolicy
      Properties:
        Queues:
          - Ref: PersonalizationQueue
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal: "*"
              Action: sqs:SendMessage
              Resource: 
                Fn::GetAtt: [PersonalizationQueue, Arn]
              Condition:
                ArnEquals:
                  aws:SourceArn: 
                    Ref: PersonalizationTopic

    # Suscripción SNS -> SQS
    PersonalizationSubscription:
      Type: AWS::SNS::Subscription
      Properties:
        Protocol: sqs
        TopicArn: 
          Ref: PersonalizationTopic
        Endpoint: 
          Fn::GetAtt: [PersonalizationQueue, Arn]

    # === SQS PARA NOTIFICACIONES DEL SISTEMA ===
    SystemNotificationsDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${sls:stage}-system-notifications-dlq
        MessageRetentionPeriod: 1209600

    SystemNotificationsQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${sls:stage}-system-notifications-queue
        VisibilityTimeout: 60
        RedrivePolicy:
          deadLetterTargetArn: 
            Fn::GetAtt: [SystemNotificationsDLQ, Arn]
          maxReceiveCount: 3

    SystemNotificationsQueuePolicy:
      Type: AWS::SQS::QueuePolicy
      Properties:
        Queues:
          - Ref: SystemNotificationsQueue
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal: "*"
              Action: sqs:SendMessage
              Resource: 
                Fn::GetAtt: [SystemNotificationsQueue, Arn]
              Condition:
                ArnEquals:
                  aws:SourceArn: 
                    Ref: SystemNotificationsTopic

    SystemNotificationsSubscription:
      Type: AWS::SNS::Subscription
      Properties:
        Protocol: sqs
        TopicArn: 
          Ref: SystemNotificationsTopic
        Endpoint: 
          Fn::GetAtt: [SystemNotificationsQueue, Arn]

    # === COGNITO ===
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:service}-${sls:stage}-pool
        UsernameAttributes:
          - email
        AutoVerifiedAttributes:
          - email
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: false
            RequireUppercase: true
        UserPoolTags:
          Environment: ${sls:stage}
          Project: HospitalPadreHurtado

    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${self:service}-${sls:stage}-app
        GenerateSecret: false
        UserPoolId: 
          Ref: CognitoUserPool
        PreventUserExistenceErrors: ENABLED
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
        AccessTokenValidity: 30
        IdTokenValidity: 30
        RefreshTokenValidity: 30
        TokenValidityUnits:
          AccessToken: minutes
          IdToken: minutes
          RefreshToken: days
    
    # === SNS ===
    PersonalizationTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:service}-${sls:stage}-personalization
        DisplayName: "Eventos de personalización de usuarios"

    SystemNotificationsTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:service}-${sls:stage}-notifications
        DisplayName: "Notificaciones del sistema"
    BrandingAssetsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:service}-${self:provider.stage}-assets
        CorsConfiguration:
          CorsRules:
            - AllowedOrigins:
                - '*'
              AllowedMethods:
                - GET
                - PUT
                - POST
              AllowedHeaders:
                - '*'
              MaxAge: 3600
        OwnershipControls:
          Rules:
            - ObjectOwnership: BucketOwnerEnforced

  Outputs:
    UserPoolId:
      Value: { Ref: CognitoUserPool }
    
    UserPoolClientId:
      Value: { Ref: CognitoUserPoolClient }
