service: aws-cognito-jwt-login
frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  region: ${opt:region, 'us-east-1'}
  stage: ${opt:stage, 'dev'}
  
  role: arn:aws:iam::211125294486:role/LabRole
  
  # Tags para mejor gestión de recursos
  tags:
    Project: HospitalPadreHurtado
    Environment: ${sls:stage}
    ManagedBy: Serverless
    Version: 1.0.0
  
  environment:
    # Variables para las funciones
    USER_POOL_ID: { Ref: CognitoUserPool }
    USER_POOL_CLIENT_ID: { Ref: CognitoUserPoolClient }
    USER_ROLES_TABLE: ${self:service}-${sls:stage}-user-roles
    PERMISSIONS_TABLE: ${self:service}-${sls:stage}-permissions
    PARAMETERS_TABLE: ${self:service}-${sls:stage}-parameters
    STAGE: ${sls:stage}
    VERSION: 1.0.0
    
  logs:
    httpApi: true
    
  httpApi:
    cors: true
    authorizers:
      cognitoJwt:
        type: jwt
        identitySource: $request.header.Authorization
        issuerUrl:
          Fn::Sub:
            - https://cognito-idp.${AWS::Region}.amazonaws.com/${UserPoolId}
            - { UserPoolId: { Ref: CognitoUserPool } }
        audience:
          - { Ref: CognitoUserPoolClient }

functions:
  # === HEALTH CHECK ===
  health:
    handler: src/handlers/health.check
    events:
      - httpApi:
          method: GET
          path: /health
    timeout: 10
    description: Health check endpoint for monitoring

  # === FUNCIONES DE AUTENTICACIÓN ===
  login:
    handler: src/handlers/login.login
    events:
      - httpApi:
          method: POST
          path: /auth/login
    timeout: 30
    description: User authentication endpoint

  refresh:
    handler: src/handlers/refresh.refresh
    events:
      - httpApi:
          method: POST
          path: /auth/refresh
    timeout: 30
    description: Token refresh endpoint

  me:
    handler: src/handlers/me.me
    events:
      - httpApi:
          method: GET
          path: /me
          authorizer:
            name: cognitoJwt
    timeout: 10
    description: Get current user information

  # === FUNCIONES DE PERMISOS ===
  getMyPermissions:
    handler: src/handlers/permissions.getMyPermissions
    events:
      - httpApi:
          method: GET
          path: /my-permissions
          authorizer:
            name: cognitoJwt
    timeout: 10
    description: Get user permissions

  checkPermission:
    handler: src/handlers/permissions.checkPermission
    events:
      - httpApi:
          method: POST
          path: /check-permission
          authorizer:
            name: cognitoJwt
    timeout: 10
    description: Check specific permission

  assignRole:
    handler: src/handlers/permissions.assignRole
    events:
      - httpApi:
          method: POST
          path: /admin/assign-role
          authorizer:
            name: cognitoJwt
    timeout: 15
    description: Assign role to user (admin only)

  listAvailablePermissions:
    handler: src/handlers/permissions.listAvailablePermissions
    events:
      - httpApi:
          method: GET
          path: /admin/available-permissions
          authorizer:
            name: cognitoJwt
    timeout: 10
    description: List all available permissions

  # === FUNCIONES DE PERSONALIZACIÓN ===
  getPersonalization:
    handler: src/handlers/personalization.getPersonalization
    events:
      - httpApi:
          method: GET
          path: /personalization
          authorizer:
            name: cognitoJwt
    timeout: 10
    description: Get user personalization settings

  setPersonalization:
    handler: src/handlers/personalization.setPersonalization
    events:
      - httpApi:
          method: POST
          path: /personalization
          authorizer:
            name: cognitoJwt
    timeout: 15
    description: Update user personalization settings

plugins:
  - serverless-offline

package:
  individually: true
  patterns:
    - '!node_modules/**'
    - '!**/*.md'
    - '!**/*.test.*'
    - '!.git/**'
    - '!.github/**'
    - '!coverage/**'
    - '!.vscode/**'

resources:
  Resources:
    # === TABLAS DYNAMODB ===
    UserRolesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-user-roles
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: user_email
            AttributeType: S
        KeySchema:
          - AttributeName: user_email
            KeyType: HASH
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        Tags:
          - Key: Environment
            Value: ${sls:stage}
          - Key: Project
            Value: HospitalPadreHurtado

    PermissionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-permissions
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: permission_id
            AttributeType: S
        KeySchema:
          - AttributeName: permission_id
            KeyType: HASH
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        Tags:
          - Key: Environment
            Value: ${sls:stage}
          - Key: Project
            Value: HospitalPadreHurtado
    
    ParametersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-parameters
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: user_sub
            AttributeType: S
          - AttributeName: parameter_key
            AttributeType: S
        KeySchema:
          - AttributeName: user_sub
            KeyType: HASH
          - AttributeName: parameter_key
            KeyType: RANGE
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        Tags:
          - Key: Environment
            Value: ${sls:stage}
          - Key: Project
            Value: HospitalPadreHurtado

    # === COGNITO ===
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:service}-${sls:stage}-pool
        UsernameAttributes:
          - email
        AutoVerifiedAttributes:
          - email
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: false
            RequireUppercase: true
        UserPoolTags:
          Environment: ${sls:stage}
          Project: HospitalPadreHurtado

    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${self:service}-${sls:stage}-app
        GenerateSecret: false
        UserPoolId: { Ref: CognitoUserPool }
        PreventUserExistenceErrors: ENABLED
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
        AccessTokenValidity: 60
        IdTokenValidity: 60
        RefreshTokenValidity: 30
        TokenValidityUnits:
          AccessToken: minutes
          IdToken: minutes
          RefreshToken: days

  Outputs:
    HttpApiUrl:
      Description: URL of the HTTP API
      Value:
        Fn::Sub: https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com
      Export:
        Name: ${self:service}-${sls:stage}-api-url
    UserPoolId:
      Description: Cognito User Pool ID
      Value: { Ref: CognitoUserPool }
      Export:
        Name: ${self:service}-${sls:stage}-user-pool-id
    UserPoolClientId:
      Description: Cognito User Pool Client ID
      Value: { Ref: CognitoUserPoolClient }
      Export:
        Name: ${self:service}-${sls:stage}-user-pool-client-id
    Stage:
      Description: Deployment stage
      Value: ${sls:stage}
    Region:
      Description: AWS Region
      Value: ${self:provider.region}