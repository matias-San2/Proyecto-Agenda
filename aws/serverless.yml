service: aws-cognito-jwt-login
frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  region: ${env:AWS_REGION, 'us-east-1'}
  stage: ${opt:stage, 'dev'}
  
  role: ${env:AWS_ROLE, 'arn:aws:iam::851725349092:role/LabRole'}
  
  environment:
    USER_POOL_ID: { Ref: CognitoUserPool }
    USER_POOL_CLIENT_ID: { Ref: CognitoUserPoolClient }
    USER_ROLES_TABLE: ${self:service}-${sls:stage}-user-roles
    PERMISSIONS_TABLE: ${self:service}-${sls:stage}-permissions
    PARAMETERS_TABLE: ${self:service}-${sls:stage}-parameters
    ACTIVITY_LOGS_TABLE: ${self:service}-${sls:stage}-activity-logs
    PERSONALIZATION_TOPIC_ARN: { Ref: PersonalizationTopic }
    SYSTEM_NOTIFICATIONS_TOPIC_ARN: { Ref: SystemNotificationsTopic }
    PROCESSED_MESSAGES_TABLE: ${self:service}-${sls:stage}-processed-messages
    SERVICE_NAME: ${self:service}
    STAGE: ${sls:stage}
    
  logs:
    httpApi: true
    
  httpApi:
    cors:
        allowedOrigins:
          - '*'
        allowedHeaders:
          - Content-Type
          - Authorization
        allowedMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        allowCredentials: false
    authorizers:
      cognitoJwt:
        type: jwt
        identitySource: $request.header.Authorization
        issuerUrl:
          Fn::Sub:
            - https://cognito-idp.${AWS::Region}.amazonaws.com/${UserPoolId}
            - { UserPoolId: { Ref: CognitoUserPool } }
        audience:
          - { Ref: CognitoUserPoolClient }
  
  iamRoleStatements:
    - Effect: Allow
      Action:
        - sns:Publish
      Resource:
        - { Ref: PersonalizationTopic }
        - { Ref: SystemNotificationsTopic }
    
    - Effect: Allow
      Action:
        - dynamodb:PutItem
        - dynamodb:GetItem
        - dynamodb:Query
        - dynamodb:Scan
      Resource:
        - { Fn::GetAtt: [ActivityLogsTable, Arn] }
        - Fn::Sub: '${ActivityLogsTable.Arn}/index/*'
    
    - Effect: Allow
      Action:
        - dynamodb:PutItem
        - dynamodb:GetItem
        - dynamodb:Query
        - dynamodb:UpdateItem
      Resource:
        - { Fn::GetAtt: [ParametersTable, Arn] }
    
    - Effect: Allow
      Action:
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
        - dynamodb:Query
        - dynamodb:Scan
      Resource:
        - { Fn::GetAtt: [UserRolesTable, Arn] }
        - Fn::Sub: '${UserRolesTable.Arn}/index/*'
    
    - Effect: Allow
      Action:
        - dynamodb:GetItem
        - dynamodb:Query
        - dynamodb:Scan
      Resource:
        - { Fn::GetAtt: [PermissionsTable, Arn] }

    - Effect: Allow
      Action:
        - sqs:ReceiveMessage
        - sqs:DeleteMessage
        - sqs:GetQueueAttributes
        - sqs:ChangeMessageVisibility
      Resource:
        - { Fn::GetAtt: [PersonalizationQueue, Arn] }
        - { Fn::GetAtt: [SystemNotificationsQueue, Arn] }

    - Effect: Allow
      Action:
        - dynamodb:PutItem
        - dynamodb:GetItem
      Resource:
        - { Fn::GetAtt: [ProcessedMessagesTable, Arn] }

functions:
  # === FUNCIONES DE AUTENTICACIÓN ===
  login:
    handler: src/handlers/login/login.login
    events:
      - httpApi:
          method: POST
          path: /auth/login

  refresh:
    handler: src/handlers/login/refresh.refresh
    events:
      - httpApi:
          method: POST
          path: /auth/refresh

  me:
    handler: src/handlers/login/me.me
    events:
      - httpApi:
          method: GET
          path: /me
          authorizer:
            name: cognitoJwt

  # === FUNCIONES DE PERMISOS ===
  getMyPermissions:
    handler: src/handlers/permissions/permissions.getMyPermissions
    events:
      - httpApi:
          method: GET
          path: /my-permissions
          authorizer:
            name: cognitoJwt

  checkPermission:
    handler: src/handlers/permissions/permissions.checkPermission
    events:
      - httpApi:
          method: POST
          path: /check-permission
          authorizer:
            name: cognitoJwt

  assignRole:
    handler: src/handlers/permissions/permissions.assignRole
    events:
      - httpApi:
          method: POST
          path: /admin/assign-role
          authorizer:
            name: cognitoJwt

  removeRole:
    handler: src/handlers/permissions/permissions.removeRole
    events:
      - httpApi:
          method: DELETE
          path: /admin/remove-role
          authorizer:
            name: cognitoJwt

  listAvailablePermissions:
    handler: src/handlers/permissions/permissions.listAvailablePermissions
    events:
      - httpApi:
          method: GET
          path: /admin/available-permissions
          authorizer:
            name: cognitoJwt

  listUsersWithRoles:
    handler: src/handlers/permissions/permissions.listUsersWithRoles
    events:
      - httpApi:
          method: GET
          path: /admin/users-with-roles
          authorizer:
            name: cognitoJwt

  # === FUNCIONES DE PERSONALIZACIÓN ===
  getPersonalization:
    handler: src/handlers/personalization/personalization.getPersonalization
    events:
      - httpApi:
          method: GET
          path: /personalization
          authorizer:
            name: cognitoJwt

  setPersonalization:
    handler: src/handlers/personalization/personalization.setPersonalization
    events:
      - httpApi:
          method: POST
          path: /personalization
          authorizer:
            name: cognitoJwt
  
  # === FUNCIONES DE COMUNICACIÓN DESACOPLADA ===
  handlePersonalizationEvents:
    handler: src/handlers/events.handlePersonalizationEvents
    events:
      - sqs:
          arn:
            Fn::GetAtt: [PersonalizationQueue, Arn]
          batchSize: 5
          maximumBatchingWindow: 10

  handleSystemNotifications:
    handler: src/handlers/events.handleSystemNotifications
    events:
      - sqs:
          arn:
            Fn::GetAtt: [SystemNotificationsQueue, Arn]
          batchSize: 5
          maximumBatchingWindow: 10

  # === FUNCIONES DE LOGS ===
  getActivityLogs:
    handler: src/handlers/logs.getActivityLogs
    events:
      - httpApi:
          method: GET
          path: /admin/activity-logs
          authorizer:
            name: cognitoJwt

  getActivityStats:
    handler: src/handlers/logs.getActivityStats
    events:
      - httpApi:
          method: GET
          path: /admin/activity-stats
          authorizer:
            name: cognitoJwt

plugins:
  - serverless-offline

package:
  individually: true
  patterns:
    - '!node_modules/**'
    - '!**/*.md'
    - '!**/*.test.*'

resources:
  Resources:
    # === DYNAMODB ===
    UserRolesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-user-roles
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: user_email
            AttributeType: S
          - AttributeName: role
            AttributeType: S
        KeySchema:
          - AttributeName: user_email
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: RoleIndex
            KeySchema:
              - AttributeName: role
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    PermissionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-permissions
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: permission_id
            AttributeType: S
        KeySchema:
          - AttributeName: permission_id
            KeyType: HASH
    
    ParametersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-parameters
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: user_sub
            AttributeType: S
          - AttributeName: parameter_key
            AttributeType: S
        KeySchema:
          - AttributeName: user_sub
            KeyType: HASH
          - AttributeName: parameter_key
            KeyType: RANGE

    ActivityLogsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-activity-logs
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: user_sub
            AttributeType: S
          - AttributeName: timestamp
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: UserActivityIndex
            KeySchema:
              - AttributeName: user_sub
                KeyType: HASH
              - AttributeName: timestamp
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
    
    # === TABLA DE AGENDA ===
    AgendaTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-agenda
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
          - AttributeName: GSI2PK
            AttributeType: S
          - AttributeName: GSI2SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: MedicoFechaIndex
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: FechaIndex
            KeySchema:
              - AttributeName: GSI2PK
                KeyType: HASH
              - AttributeName: GSI2SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    # === TABLA DE CATÁLOGOS ===
    CatalogoTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-catalogo
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: TipoEntidadIndex
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    # === TABLA DE RELACIONES BOX-INSTRUMENTO ===
    BoxInstrumentoTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-box-instrumento
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: InstrumentoBoxIndex
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    # === TABLA DE NOTIFICACIONES ===
    NotificacionTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-notificacion
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: TipoFechaIndex
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
    
    # === TABLA DE IDEMPOTENCIA ===
    ProcessedMessagesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-processed-messages
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: message_id
            AttributeType: S
        KeySchema:
          - AttributeName: message_id
            KeyType: HASH
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true

    # === SQS PARA PERSONALIZACIÓN ===
    PersonalizationDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${sls:stage}-personalization-dlq
        MessageRetentionPeriod: 1209600 # 14 días

    PersonalizationQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${sls:stage}-personalization-queue
        VisibilityTimeout: 60
        RedrivePolicy:
          deadLetterTargetArn: { Fn::GetAtt: [PersonalizationDLQ, Arn] }
          maxReceiveCount: 3

    # Permitir que SNS publique en la cola
    PersonalizationQueuePolicy:
      Type: AWS::SQS::QueuePolicy
      Properties:
        Queues:
          - { Ref: PersonalizationQueue }
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal: "*"
              Action: sqs:SendMessage
              Resource: { Fn::GetAtt: [PersonalizationQueue, Arn] }
              Condition:
                ArnEquals:
                  aws:SourceArn: { Ref: PersonalizationTopic }

    # Suscripción SNS -> SQS
    PersonalizationSubscription:
      Type: AWS::SNS::Subscription
      Properties:
        Protocol: sqs
        TopicArn: { Ref: PersonalizationTopic }
        Endpoint: { Fn::GetAtt: [PersonalizationQueue, Arn] }

    # === SQS PARA NOTIFICACIONES DEL SISTEMA ===
    SystemNotificationsDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${sls:stage}-system-notifications-dlq
        MessageRetentionPeriod: 1209600

    SystemNotificationsQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${sls:stage}-system-notifications-queue
        VisibilityTimeout: 60
        RedrivePolicy:
          deadLetterTargetArn: { Fn::GetAtt: [SystemNotificationsDLQ, Arn] }
          maxReceiveCount: 3

    SystemNotificationsQueuePolicy:
      Type: AWS::SQS::QueuePolicy
      Properties:
        Queues:
          - { Ref: SystemNotificationsQueue }
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal: "*"
              Action: sqs:SendMessage
              Resource: { Fn::GetAtt: [SystemNotificationsQueue, Arn] }
              Condition:
                ArnEquals:
                  aws:SourceArn: { Ref: SystemNotificationsTopic }

    SystemNotificationsSubscription:
      Type: AWS::SNS::Subscription
      Properties:
        Protocol: sqs
        TopicArn: { Ref: SystemNotificationsTopic }
        Endpoint: { Fn::GetAtt: [SystemNotificationsQueue, Arn] }

    # === COGNITO ===
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:service}-${sls:stage}-pool
        UsernameAttributes:
          - email
        AutoVerifiedAttributes:
          - email
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: false
            RequireUppercase: true

    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${self:service}-${sls:stage}-app
        GenerateSecret: false
        UserPoolId: { Ref: CognitoUserPool }
        PreventUserExistenceErrors: ENABLED
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
        AccessTokenValidity: 5
        IdTokenValidity: 5
        RefreshTokenValidity: 30
        TokenValidityUnits:
          AccessToken: minutes
          IdToken: minutes
          RefreshToken: days
    
    # === SNS ===
    PersonalizationTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:service}-${sls:stage}-personalization
        DisplayName: "Eventos de personalización de usuarios"

    SystemNotificationsTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:service}-${sls:stage}-notifications
        DisplayName: "Notificaciones del sistema"

  Outputs:
    UserPoolId:
      Value: { Ref: CognitoUserPool }
    
    UserPoolClientId:
      Value: { Ref: CognitoUserPoolClient }
    
    PersonalizationTopicArn:
      Value: { Ref: PersonalizationTopic }
    
    SystemNotificationsTopicArn:
      Value: { Ref: SystemNotificationsTopic }
    
    ActivityLogsTableName:
      Value: { Ref: ActivityLogsTable }
    
    ApiEndpoint:
      Value:
        Fn::Sub: 'https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com'
    
    PersonalizationQueueUrl:
      Value: { Ref: PersonalizationQueue }

    SystemNotificationsQueueUrl:
      Value: { Ref: SystemNotificationsQueue }
