<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Box por Pasillo</title>
  <link rel="stylesheet" href="/css/navbar.css">
  <link rel="stylesheet" href="/css/box.css">
  <link rel="stylesheet" href="/css/footer.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
        --personalization-loaded: true;
        
        <% if (personalization && personalization['theme.primary_color']) { %>
        --primary-color: <%= personalization['theme.primary_color'] %>!important;
        <% if (personalization['theme.primary_color_light']) { %>
        --primary-color-light: <%= personalization['theme.primary_color_light'] %>!important;
        <% } %>
        <% if (personalization['theme.primary_color_dark']) { %>
        --primary-color-dark: <%= personalization['theme.primary_color_dark'] %>!important;
        <% } %>
        <% } %>
        
        <% if (personalization && personalization['theme.mode'] === 'dark') { %>
        --background-color: #181818 !important;
        --text-color: rgba(241, 241, 241, 0.98) !important;
        --secondary-text-color: #aab1bb !important;
        --card-background: #222222 !important;
        --border-color: #2b2b2b !important;
        <% } %>
        }
        <% if (personalization && personalization['theme.mode'] === 'dark') { %>
        .menu-link img {
            filter: brightness(0) invert(1)!important;
        }
        <% } %>
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <%- include('navbar') %>

            <div class="main">
                <!-- Botón flotante: Consultas en curso -->
                <% if (canWrite) { %>
                    <a href="/en-curso"
                        class="fab-consultas"
                        aria-label="Ir a Consultas en curso"
                        data-bs-toggle="tooltip"
                        data-bs-placement="left"
                        title="Consultas en curso">
                        <i class="fas fa-stethoscope" aria-hidden="true"></i>
                    </a>
                <% } %>

                <!-- Botón flotante: Volver arriba -->
                <button id="backToTop"
                        class="back-to-top"
                        type="button"
                        aria-label="Volver a la parte superior"
                        title="Volver arriba">
                    <i class="fas fa-arrow-up" aria-hidden="true"></i>
                </button>

                <div class="top-header">
                    <div class="header-row">
                    <h1>Pasillos y Boxes</h1>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="filtros">
                    <div class="filtros-inputs">
                    <input type="text" id="filtroPasillo" placeholder="Filtrar por número de pasillo" aria-label="Filtrar por número de pasillo">
                    <input type="text" id="filtroBox" placeholder="Filtrar por número de box" aria-label="Filtrar por número de box">
                    <select id="filtroEstado" aria-label="Filtrar por estado del box">
                        <option value="">Mostrar todos</option>
                        <option value="en-uso">En uso</option>
                        <option value="en-espera">En espera</option>
                        <option value="libre">Libre</option>
                        <option value="inhabilitado">Inhabilitado</option>
                    </select>
                    </div>
                    <div class="filtros-botones">
                    <button onclick="reiniciarFiltros()">Reiniciar filtros</button>
                    <button id="toggle-detalles" class="btn-toggle-detalles">Mostrar detalles</button>
                    </div>
                </div>

                <!-- Resumen de estados -->
                <div class="resumen-estados row align-items-stretch" id="resumenEstados">
                    <div class="col-5 col-sm-5 col-md-3 col-lg-2 mb-4">
                    <div class="estado-card libre">
                        <h4>Boxes Libres</h4>
                        <p id="count-libre">0</p>
                    </div>
                    </div>
                    <div class="col-5 col-sm-5 col-md-3 col-lg-2 mb-4">
                    <div class="estado-card en-espera">
                        <h4>En espera</h4>
                        <p id="count-en-espera">0</p>
                    </div>
                    </div>
                    <div class="col-5 col-sm-5 col-md-3 col-lg-2 mb-4">
                    <div class="estado-card en-uso">
                        <h4>En Uso</h4>
                        <p id="count-en-uso">0</p>
                    </div>
                    </div>
                    <div class="col-5 col-sm-5 col-md-3 col-lg-2 mb-4">
                    <div class="estado-card inhabilitado">
                        <h4>Inhabilitados</h4>
                        <p id="count-inhabilitado">0</p>
                    </div>
                    </div>
                </div>

                <!-- Mensaje sin resultados -->
                <div id="mensaje-no-resultados" class="no-resultados" style="display: none;">
                    <i class="fas fa-search"></i>
                    <h3>No se encontraron resultados</h3>
                    <p>No hay boxes que coincidan con los filtros aplicados. Intenta ajustar los criterios de búsqueda.</p>
                </div>

                <!-- Render dinámico de pasillos y boxes -->
                <% Object.keys(pasillo_box_map).forEach(pasilloNombre => { %>
                    <div class="pasillo-bloque" data-pasillo-nombre="<%= pasilloNombre %>">
                        <div class="pasillo-nombre"><%= pasilloNombre %></div>
                        <div class="pasillo-content row">
                        <% pasillo_box_map[pasilloNombre].forEach(box => { %>
                            <div class="col-12 col-sm-6 col-md-4 col-lg-4 col-xl-3 col-xxl-2 mb-3">
                            <% if (canViewDetail) { %>
                                <!-- Si tiene permiso, hacer clickeable -->
                                <a href="/box/<%= box.id %>" 
                                class="box-card" 
                                data-box-nombre="<%= box.nombre %>" 
                                data-pasillo="<%= pasilloNombre %>">
                            <% } else { %>
                                <!-- Si no tiene permiso, mostrar como div sin enlace -->
                                <div class="box-card disabled" 
                                data-box-nombre="<%= box.nombre %>" 
                                data-pasillo="<%= pasilloNombre %>"
                                title="Sin permisos para ver detalles">
                            <% } %>
                                <h3><%= box.nombre %></h3>
                                <div id="info-box-<%= box.id %>" class="info-box">
                                    <div class="contenido-box oculto">
                                        <p>Próxima consulta: No hay próxima consulta hoy</p>
                                    </div>
                                    <div class="estado-bar <%= box.estado.toLowerCase().replace(' ', '-') %>">
                                        <%= box.estado %>
                                    </div>
                                </div>
                            <% if (canViewDetail) { %>
                                </a>
                            <% } else { %>
                                </div>
                            <% } %>
                            </div>
                        <% }) %>
                        </div>
                    </div>
                <% }) %>
            </div>

            <%- include('footer') %>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/box.js?v=<%= Date.now() %>"></script>
    <script>
        window.userPersonalization = <%- JSON.stringify(personalization || {}) %>;
    </script>
</body>
</html>