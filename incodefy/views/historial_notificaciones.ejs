<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Historial Notificaciones</title>
  <link rel="stylesheet" href="/css/navbar.css">
  <link rel="stylesheet" href="/css/historial_notificaciones.css">
  <link rel="stylesheet" href="/css/footer.css">
  <link rel="stylesheet" href="/css/notificacion.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- El bloque <style> se ha eliminado y se reemplaza por esta línea -->
  <%- include('partials/personalization-styles') %>

</head>
<!-- Se añade el atributo data-theme al body para el modo oscuro/claro -->
<body data-theme="<%= (locals.personalization && personalization['theme.mode']) || 'light' %>">
  <div class="container-fluid">
    <div class="row">
      <%- include("navbar") %>

      <div class="main">
        <div class="header-section">
          <h1>
            <i class="fas fa-bell me-2 header-icon"></i>
            Historial de Notificaciones
          </h1>
          <p>Mantente al día con todas las actividades y actualizaciones del sistema</p>
        </div>

        <div class="notificaciones-container">
          <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
          </div>
          <div class="notificaciones-lista" id="notificacionesLista" style="display: none;"></div>
        </div>
      </div>

      <%- include("footer") %>
    </div>
  </div>

  <!-- Modal para mostrar detalles de la importación -->
  <div class="modal fade" id="modalDetalleImportacion" tabindex="-1" aria-labelledby="detalleImportacionLabel" aria-hidden="true">
    <!-- ...existing code... -->
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-medical">
          <h5 class="modal-title" id="detalleImportacionLabel">
            Detalles de la Importación
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle mb-0">
              <!-- ...existing code... -->
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function cargarHistorialNotificaciones() {
      const loadingSpinner = document.getElementById('loadingSpinner');
      const contenedor = document.getElementById('notificacionesLista');

      loadingSpinner.style.display = 'flex';
      contenedor.style.display = 'none';

      fetch('/notificaciones-usuario')
        .then(r => r.json())
        .then(data => {
          loadingSpinner.style.display = 'none';
          contenedor.style.display = 'block';
          mostrarNotificaciones(data);
        })
        .catch(() => {
          loadingSpinner.style.display = 'none';
          contenedor.style.display = 'block';
          contenedor.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <h4>Error al cargar notificaciones</h4>
              <p>Por favor, intenta nuevamente más tarde.</p>
            </div>
          `;
        });
    }

    function mostrarNotificaciones(data) {
      const contenedor = document.getElementById('notificacionesLista');
      contenedor.innerHTML = "";

      if (!data.notificaciones.length) {
        contenedor.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-bell-slash"></i>
            <h4>No hay notificaciones</h4>
            <p>Cuando tengas nuevas notificaciones, aparecerán aquí.</p>
          </div>
        `;
        return;
      }

      data.notificaciones.forEach(n => {
        const item = document.createElement("div");
        item.className = "notificacion-item";
        item.innerHTML = `
          <div class="fecha-noti"><i class="fas fa-clock"></i> ${n.fecha}</div>
          <div class="mensaje-noti">${n.mensaje}</div>
          <button class="btn btn-detalle" aria-label="Ver detalles de notificación" onclick='mostrarDetalleImportacion(${JSON.stringify(n.detalle)})'>
            <i class="fas fa-eye me-2" aria-hidden="true"></i>Ver detalles
          </button>
        `;
        contenedor.appendChild(item);
      });
    }

    function mostrarDetalleImportacion(detalle) {
      const tbody = document.getElementById("detalleImportacionTablaBody");
      tbody.innerHTML = "";

      detalle.forEach(c => {
        const row = document.createElement("tr");
        
        let badgeClass = 'badge-pendiente';
        if (c.estado && c.estado.toLowerCase() === 'atendido') {
          badgeClass = 'badge-confirmado';
        } else if (c.estado && c.estado.toLowerCase() === 'cancelado') {
          badgeClass = 'badge-cancelado';
        }
        
        row.innerHTML = `
          <td>${c.fecha || '-'}</td>
          <td>${c.horainicio || '-'}</td>
          <td>${c.horafin || '-'}</td>
          <td>${c.medico || '-'}</td>
          <td>${c.box || '-'}</td>
          <td>${c.tipoconsulta || '-'}</td>
          <td><span class="badge badge-estado ${badgeClass}">${c.estado || 'Pendiente'}</span></td>
        `;
        tbody.appendChild(row);
      });

      // Mostrar modal
      const modal = new bootstrap.Modal(document.getElementById('modalDetalleImportacion'));
      modal.show();
      
      // Remover la notificación si existe
      const notificacionExistente = document.querySelector('.notificacion-importacion');
      if (notificacionExistente) {
        notificacionExistente.classList.remove('show');
        setTimeout(() => {
          notificacionExistente.remove();
        }, 300);
      }
    }
    document.addEventListener('DOMContentLoaded', cargarHistorialNotificaciones);
  </script>
  <script>
    window.userPersonalization = <%- JSON.stringify(personalization || {}) %>;
  </script>
</body>
</html>