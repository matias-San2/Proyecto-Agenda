<!DOCTYPE html>
<html lang="<%= lang %>">

<head>
  <meta charset="UTF-8">
  <title><%= t('notifications.history_title') %></title>
  <link rel="stylesheet" href="/css/navbar.css">
  <link rel="stylesheet" href="/css/historial_notificaciones.css">
  <link rel="stylesheet" href="/css/footer.css">
  <link rel="stylesheet" href="/css/notificacion.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- El bloque <style> se ha eliminado y se reemplaza por esta línea -->
  <%- include('partials/personalization-styles') %>

</head>
<!-- Se añade el atributo data-theme al body para el modo oscuro/claro -->
<body data-theme="<%= (locals.personalization && personalization['theme.mode']) || 'light' %>">
  <div class="container-fluid">
    <div class="row">
      <%- include("navbar") %>

      <div class="main">
        <div class="header-section">
          <h1>
            <i class="fas fa-bell me-2 header-icon"></i>
            <%= t('notifications.history_header') %>
          </h1>
          <p><%= t('notifications.history_subheader') %></p>
        </div>

        <div class="notificaciones-container">
          <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
          </div>
          <div class="notificaciones-lista" id="notificacionesLista" style="display: none;"></div>
        </div>
      </div>

      <%- include("footer") %>
    </div>
  </div>

  <!-- Modal para mostrar detalles de la importación -->
  <div class="modal fade" id="modalDetalleImportacion" tabindex="-1" aria-labelledby="detalleImportacionLabel" aria-hidden="true">
    <!-- ...existing code... -->
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-medical">
          <h5 class="modal-title" id="detalleImportacionLabel">
            <%= t('common.import_details') %>
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="<%= t('common.close') %>"></button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle mb-0">
              <caption class="visually-hidden"><%= t('common.import_table_caption') %></caption>
              <thead>
                <tr>
                  <th><%= t('common.date') %></th>
                  <th><%= t('common.start_time') %></th>
                  <th><%= t('common.end_time') %></th>
                  <th><%= t('common.doctor') %></th>
                  <th><%= t('common.box') %></th>
                  <th><%= t('common.consult_type') %></th>
                  <th><%= t('common.status') %></th>
                </tr>
              </thead>
              <tbody id="detalleImportacionTablaBody">
                <!-- Filas se insertan dinámicamente -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Locale to use for date/time formatting based on current UI language
    const CURRENT_LOCALE = '<%= i18n.language %>';

    // Basic HTML escaping to avoid injection from notification messages
    function escapeHTML(str) {
      if (typeof str !== 'string') return str;
      return str
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function cargarHistorialNotificaciones() {
      const loadingSpinner = document.getElementById('loadingSpinner');
      const contenedor = document.getElementById('notificacionesLista');

      loadingSpinner.style.display = 'flex';
      contenedor.style.display = 'none';

      fetch('/notificaciones-usuario')
        .then(r => r.json())
        .then(data => {
          loadingSpinner.style.display = 'none';
          contenedor.style.display = 'block';
          // Pasar las cabeceras traducidas a la función que muestra las notificaciones
          mostrarNotificaciones(data.notificaciones, data.headers);
        })
        .catch(() => {
          loadingSpinner.style.display = 'none';
          contenedor.style.display = 'block';
          contenedor.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-exclamation-circle empty-state-icon"></i>
              <p class="empty-state-title"><%= t('common.error_loading_notifications') %></p>
              <p class="empty-state-text"><%= t('common.try_again_later') %></p>
            </div>
          `;
        });
    }

    function mostrarNotificaciones(notificaciones, headers) {
      const contenedor = document.getElementById('notificacionesLista');
      if (!notificaciones || notificaciones.length === 0) {
        contenedor.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-bell-slash empty-state-icon"></i>
            <p class="empty-state-title"><%= t('common.no_notifications') %></p>
            <p class="empty-state-text"><%= t('common.no_notifications_desc') %></p>
          </div>
        `;
        return;
      }

      const notificacionesPorFecha = notificaciones.reduce((acc, n) => {
        const fecha = new Date(n.fecha).toISOString().split('T')[0];
        if (!acc[fecha]) acc[fecha] = [];
        acc[fecha].push(n);
        return acc;
      }, {});

      let html = '';
      for (const fecha in notificacionesPorFecha) {
        const fechaLabel = new Intl.DateTimeFormat(CURRENT_LOCALE, {
          weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        }).format(new Date(fecha));

        html += `<div class="fecha-grupo">
                    <div class="fecha-etiqueta"><i class=\"far fa-calendar-alt me-2\"></i>${fechaLabel}</div>`;
        notificacionesPorFecha[fecha].forEach(n => {
          const detalleString = JSON.stringify(n.detalle).replace(/"/g, '&quot;');
          const horaLabel = new Intl.DateTimeFormat(CURRENT_LOCALE, { hour: '2-digit', minute: '2-digit' }).format(new Date(n.fecha));
          html += `
            <div class="notificacion-item">
              <div class="fecha-noti"><i class="far fa-clock me-2"></i> ${horaLabel}</div>
              <div class="mensaje-noti">${escapeHTML(n.mensaje)}</div>
              <button class="btn btn-detalle" 
                      aria-label="<%= t('notifications.view_details_aria') %>"
                      data-bs-toggle="modal" 
                      data-bs-target="#modalDetalleImportacion" 
                      data-detalle='${detalleString}'>
                <%= t('common.view_details') %>
              </button>
            </div>
          `;
        });
        html += `</div>`;
      }
      contenedor.innerHTML = html;

      // Actualizar las cabeceras del modal dinámicamente
      const modalHeaderRow = document.querySelector('#modalDetalleImportacion thead tr');
      if (modalHeaderRow && headers) {
        modalHeaderRow.innerHTML = `
          <th>${headers.date}</th>
          <th>${headers.start_time}</th>
          <th>${headers.end_time}</th>
          <th>${headers.doctor}</th>
          <th>${headers.box}</th>
          <th>${headers.consult_type}</th>
          <th>${headers.status}</th>
        `;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      cargarHistorialNotificaciones();

      const modal = document.getElementById('modalDetalleImportacion');
      modal.addEventListener('show.bs.modal', event => {
        const button = event.relatedTarget;
        const detalle = JSON.parse(button.getAttribute('data-detalle'));
        const tablaBody = document.getElementById('detalleImportacionTablaBody');
        
        tablaBody.innerHTML = '';
        if (Array.isArray(detalle)) {
          detalle.forEach(d => {
            console.log(d.tipoconsulta)
            const row = `
              <tr>
                <td>${d.fecha || '-'}</td>
                <td>${d.horaInicio || '-'}</td>
                <td>${d.horaFin || '-'}</td>
                <td>${d.medico || '-'}</td>
                <td>${d.box || '-'}</td>
                <td>${d.tipoconsulta || '-'}</td>
                <td><span class="badge ${d.estado === '<%= t("common.pending") %>' ? 'bg-warning' : 'bg-success'}">${d.estado || '-'}</span></td>
              </tr>
            `;
            tablaBody.innerHTML += row;
          });
        }
      });
    });
  </script>
</body>
</html>