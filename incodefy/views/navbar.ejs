<% const brandingSource = (typeof personalization !== 'undefined' && personalization) ? personalization : (locals && locals.personalization ? locals.personalization : null); %>
<% const branding = (brandingSource && brandingSource.branding) ? brandingSource.branding : {}; %>
<nav class="custom-navbar">
  <div class="navbar-toggle" onclick="toggleNavbar()" aria-label="Abrir menú de navegación">
    <i class="fas fa-bars"></i>
  </div>
  
  <div class="navbar-title">
    <a class="logo" href="/">
      <img src="<%= branding.logo || '/logos/logo_hospital.png' %>" class="brand-logo" alt="Home">
    </a>
  </div>

  <!-- Overlay para cerrar el menú -->
  <div class="navbar-overlay" onclick="closeNavbar()"></div>

  <ul class="navbar-menu">
    <% if (user && user.permissions) { %>
      <!-- Dashboard -->
      <% if (user.permissions.includes('dashboard.read') || user.permissions.includes('admin.users')) { %>
        <li>
          <a href="/dashboard" class="menu-link <%= currentPath === '/dashboard' ? 'active' : '' %>" data-tooltip="<%= t('navbar.dashboard', 'Panel') %>">
            <img src="<%= (branding.icons && branding.icons.agenda) || '/icons/dashboard.webp' %>" class="icon" alt="">
            <span><%= t('navbar.dashboard', 'Panel') %></span>
          </a>
        </li>
      <% } %>
      
      <!-- Agendamientos -->
      <% if (user.permissions.includes('agenda.read') || user.permissions.includes('admin.users')) { %>
        <li>
          <a href="/agendamientos" class="menu-link <%= currentPath.startsWith('/agendamientos') ? 'active' : '' %>" data-tooltip="<%= t('navbar.agenda', 'Agendamientos') %>">
            <img src="<%= (branding.icons && branding.icons.agenda) || '/icons/calendario.webp' %>" class="icon" alt="">
            <span><%= t('navbar.agenda', 'Agendamientos') %></span>
          </a>
        </li>
      <% } %>
      
      <!-- Recursos (gestión de agenda) -->
      <% if (user.permissions.includes('agenda.write') || user.permissions.includes('admin.users')) { %>
        <li>
          <a href="/recursos" class="menu-link <%= currentPath.startsWith('/recursos') ? 'active' : '' %>" data-tooltip="<%= t('navbar.resources', 'Administración de recursos') %>">
            <span><%= t('navbar.resources', 'Administración de recursos') %></span>
          </a>
        </li>
      <% } %>
      
      <!-- Box -->
    <% } %>
    
    <!-- Notificaciones -->
    <% if (user && (user.permissions?.includes('notificaciones.read') || user.permissions?.includes('admin.users'))) { %>
      <li>
        <a href="/historial-notificaciones" class="menu-link <%= currentPath.startsWith('/historial-notificaciones') ? 'active' : '' %>" data-tooltip="<%= t('navbar.notifications', 'Notificaciones') %>">
          <img src="/icons/notificaciones.webp" alt="" class="noti">
          <span><%= t('navbar.notifications', 'Notificaciones') %></span>
        </a>
      </li>
    <% } %>

    <li>
      <a href="/perfil" class="menu-link <%= currentPath.startsWith('/perfil') ? 'active' : '' %>" data-tooltip="<%= t('navbar.profile', 'Perfil') %>">
        <img src="/icons/perfil.png" alt="" class="perfil">
        <span><%= t('navbar.profile', 'Perfil') %></span>
      </a>
    </li>
    
    <!-- Logout siempre visible -->
    <li>
      <a href="/logout" class="logout-button">
        <span><%= t('navbar.logout', 'Cerrar Sesión') %></span>
      </a>
    </li>
  </ul>
  <div class="reloj-wrapper" id="reloj"></div>
</nav>

<script>
  function actualizarReloj() {
    const now = new Date();
    const hh = String(now.getHours()).padStart(2, '0');
    const mm = String(now.getMinutes()).padStart(2, '0');
    const ss = String(now.getSeconds()).padStart(2, '0');
    document.getElementById('reloj').textContent = `${hh} : ${mm} : ${ss}`;
  }

  function toggleNavbar() {
    const navbar = document.querySelector('.navbar-menu');
    const overlay = document.querySelector('.navbar-overlay');
    navbar.classList.toggle('show');
    overlay.classList.toggle('show');
  }

  function closeNavbar() {
    const navbar = document.querySelector('.navbar-menu');
    const overlay = document.querySelector('.navbar-overlay');
    navbar.classList.remove('show');
    overlay.classList.remove('show');
  }

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeNavbar();
    }
  });

  actualizarReloj();
  setInterval(actualizarReloj, 1000);
</script>
