<!DOCTYPE html>
<html lang="<%= lng || 'es' %>">
<head>
  <meta charset="UTF-8">
  <title><%= t('dashboard.title', 'Panel de Agendamientos') %></title>
  <link rel="stylesheet" href="/css/navbar.css">
  <link rel="stylesheet" href="/css/dashboard.css">
  <link rel="stylesheet" href="/css/footer.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <%- include('partials/personalization-styles') %>
</head>
<body data-theme="<%= (personalization && personalization['theme.mode']) || 'light' %>">
  <% const brandingSource = (typeof personalization !== 'undefined' && personalization) ? personalization : (locals && locals.personalization ? locals.personalization : null); %>
  <% const branding = (brandingSource && brandingSource.branding) ? brandingSource.branding : {}; %>
  <% const brandingIcons = (branding && branding.icons) ? branding.icons : {}; %>
  <% const brandName = (branding && branding.name) ? branding.name : 'MASFI'; %>
  <div class="container-fluid">
    <div class="row">
      <%- include('navbar') %>
      <div class="main">
        <div class="header-section">
          <h1>
            <% if (branding && branding.logo) { %>
              <img src="<%= branding.logo %>" class="brand-logo me-2 header-icon" alt="<%= brandName %>">
            <% } else { %>
              <span class="brand-text me-2 header-icon"><%= brandName %></span>
            <% } %>
            <%= t('dashboard.title', 'Panel de Agendamientos') %>
          </h1>
          <p><%= t('dashboard.subtitle', 'Vista consolidada de reservas, bloqueos y uso de recursos') %></p>
        </div>

        <div class="container mt-3">
          <div class="dashboard-filter-section">
            <div class="row g-3 align-items-end">
              <div class="col-12 col-md-3">
                <label class="form-label"><%= t('dashboard.filters.from', 'Desde') %></label>
                <input type="date" class="form-control" id="filtroInicio">
              </div>
              <div class="col-12 col-md-3">
                <label class="form-label"><%= t('dashboard.filters.to', 'Hasta') %></label>
                <input type="date" class="form-control" id="filtroFin">
              </div>
              <div class="col-12 col-md-2">
                <label class="form-label"><%= t('dashboard.filters.type', 'Tipo de recurso') %></label>
                <select id="filtroTipo" class="form-select"></select>
              </div>
              <div class="col-12 col-md-2">
                <label class="form-label"><%= t('dashboard.filters.building', 'Edificio') %></label>
                <select id="filtroBuilding" class="form-select"></select>
              </div>
              <div class="col-12 col-md-2">
                <label class="form-label"><%= t('dashboard.filters.zone', 'Zona/Piso') %></label>
                <select id="filtroZone" class="form-select"></select>
              </div>
            </div>
          </div>
        </div>

        <div class="dashboard-section-title-container">
          <h2 class="dashboard-section-title"><%= t('dashboard.sections.kpis', 'Indicadores clave') %></h2>
        </div>

        <div class="row gy-4 dashboard-kpi-container">
          <div class="col-12 col-md-6 col-lg-3">
            <div class="dashboard-kpi-card">
              <div class="dashboard-kpi-title"><i class="fa-regular fa-calendar-check me-2"></i><%= t('dashboard.kpis.total', 'Total reservas') %></div>
              <div class="dashboard-kpi-percentage" id="kpi-total">--</div>
              <div class="dashboard-kpi-subtext" id="kpi-total-sub"><%= t('dashboard.kpis.total_sub', 'Periodo seleccionado') %></div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <div class="dashboard-kpi-card">
              <div class="dashboard-kpi-title"><i class="fa-solid fa-ban me-2"></i><%= t('dashboard.kpis.blocks', 'Bloqueos') %></div>
              <div class="dashboard-kpi-percentage" id="kpi-bloqueos">--</div>
              <div class="dashboard-kpi-subtext" id="kpi-bloqueos-sub"><%= t('dashboard.kpis.blocks_sub', 'Eventos bloqueados') %></div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <div class="dashboard-kpi-card">
              <div class="dashboard-kpi-title"><i class="fa-solid fa-chart-pie me-2"></i><%= t('dashboard.kpis.occupancy', 'Ocupación') %></div>
              <div class="dashboard-kpi-percentage" id="kpi-ocupacion">--</div>
              <div class="dashboard-kpi-subtext" id="kpi-ocupacion-sub"><%= t('dashboard.kpis.occupancy_sub', 'Recursos x días') %></div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <div class="dashboard-kpi-card">
              <div class="dashboard-kpi-title"><i class="fa-regular fa-clock me-2"></i><%= t('dashboard.kpis.avg', 'Promedio diario') %></div>
              <div class="dashboard-kpi-percentage" id="kpi-promedio">--</div>
              <div class="dashboard-kpi-subtext" id="kpi-promedio-sub"><%= t('dashboard.kpis.avg_sub', 'Reservas por día') %></div>
            </div>
          </div>
        </div>

        <div class="dashboard-section-title-container">
          <h2 class="dashboard-section-title"><%= t('dashboard.sections.charts', 'Visión de reservas') %></h2>
        </div>

        <div class="dashboard-visualization-row">
          <div class="row gy-4 compact-chart-row">
            <div class="col-12 col-lg-6">
              <div class="dashboard-chart-container-card">
                <div class="dashboard-chart-title"><i class="fas fa-calendar-week me-2"></i><%= t('dashboard.charts.byDay', 'Reservas por día') %></div>
                <canvas id="chartDia"></canvas>
              </div>
            </div>
            <div class="col-12 col-lg-6">
              <div class="dashboard-chart-container-card">
                <div class="dashboard-chart-title"><i class="fas fa-cubes me-2"></i><%= t('dashboard.charts.byType', 'Reservas por tipo de recurso') %></div>
                <canvas id="chartTipo"></canvas>
              </div>
            </div>
            <div class="col-12">
              <div class="dashboard-chart-container-card">
                <div class="dashboard-chart-title"><i class="fas fa-building me-2"></i><%= t('dashboard.charts.byLocation', 'Reservas por ubicación') %></div>
                <canvas id="chartUbic"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
      <%- include('footer') %>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const dashboardText = {
      loadError: "<%= t('dashboard.messages.load_error', 'Error cargando dashboard') %>"
    };
    let chartDia, chartTipo, chartUbic;

    function fillSelect(id, values, label) {
      const sel = document.getElementById(id);
      sel.innerHTML = `<option value="">${label}</option>`;
      (values || []).forEach(v => {
        sel.insertAdjacentHTML("beforeend", `<option value="${v}">${v}</option>`);
      });
    }

    async function loadFilters() {
      const r = await fetch('/dashboard/filtros-agenda');
      const data = await r.json();
      const allLabel = "<%= t('dashboard.filters.all', 'Todos') %>";
      fillSelect('filtroTipo', data.tipos || [], allLabel);
      fillSelect('filtroBuilding', data.buildings || [], allLabel);
      fillSelect('filtroZone', data.zones || [], allLabel);
    }

    async function loadData() {
      const body = {
        fecha_inicio: document.getElementById('filtroInicio').value,
        fecha_fin: document.getElementById('filtroFin').value,
        tipo: document.getElementById('filtroTipo').value,
        building: document.getElementById('filtroBuilding').value,
        zone: document.getElementById('filtroZone').value
      };
      const res = await fetch('/dashboard/datos-agenda', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(txt);
      }
      return res.json();
    }

    function renderKPIs(kpis) {
      document.getElementById('kpi-total').textContent = kpis.totalReservas ?? 0;
      document.getElementById('kpi-bloqueos').textContent = kpis.totalBloqueos ?? 0;
      document.getElementById('kpi-ocupacion').textContent = (kpis.ocupacion ?? 0) + '%';
      document.getElementById('kpi-promedio').textContent = kpis.promedioDia ?? 0;
    }

    function renderChart(id, data, label) {
      const ctx = document.getElementById(id).getContext('2d');
      const cfg = {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
            label,
            data: data.data,
            backgroundColor: '#3b82f6',
            borderRadius: 8
          }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      };
      if (id === 'chartDia') {
        if (chartDia) chartDia.destroy();
        chartDia = new Chart(ctx, { ...cfg, type: 'line', data: { ...cfg.data, datasets: [{ ...cfg.data.datasets[0], fill: false, borderColor: '#2563eb' }] } });
      } else if (id === 'chartTipo') {
        if (chartTipo) chartTipo.destroy(); chartTipo = new Chart(ctx, cfg);
      } else if (id === 'chartUbic') {
        if (chartUbic) chartUbic.destroy(); chartUbic = new Chart(ctx, cfg);
      }
    }

    async function refresh() {
      try {
        const data = await loadData();
        renderKPIs(data.kpis || {});
        renderChart('chartDia', data.charts?.reservasPorDia || { labels: [], data: [] }, "<%= t('dashboard.charts.byDay', 'Reservas por día') %>");
        renderChart('chartTipo', data.charts?.reservasPorTipo || { labels: [], data: [] }, "<%= t('dashboard.charts.byType', 'Reservas por tipo de recurso') %>");
        renderChart('chartUbic', data.charts?.reservasPorUbicacion || { labels: [], data: [] }, "<%= t('dashboard.charts.byLocation', 'Reservas por ubicación') %>");
      } catch (e) {
        console.error(dashboardText.loadError, e);
      }
    }

    (function init() {
      const hoy = new Date().toISOString().slice(0,10);
      document.getElementById('filtroInicio').value = hoy;
      document.getElementById('filtroFin').value = hoy;
      loadFilters();
      ['filtroInicio','filtroFin','filtroTipo','filtroBuilding','filtroZone'].forEach(id => {
        document.getElementById(id)?.addEventListener('change', refresh);
      });
      refresh();
    })();
  </script>
</body>
</html>
