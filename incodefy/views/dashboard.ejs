<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Administración</title>
    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Variables CSS personalizadas -->
    <style>
        :root {
        --personalization-loaded: true;
        
        <% if (personalization && personalization['theme.primary_color']) { %>
        --primary-color: <%= personalization['theme.primary_color'] %>!important;
        <% if (personalization['theme.primary_color_light']) { %>
        --primary-color-light: <%= personalization['theme.primary_color_light'] %>!important;
        <% } %>
        <% if (personalization['theme.primary_color_dark']) { %>
        --primary-color-dark: <%= personalization['theme.primary_color_dark'] %>!important;
        <% } %>
        <% } %>
        
        <% if (personalization && personalization['theme.mode'] === 'dark') { %>
        --background-color: #181818 !important;
        --text-color: rgba(241, 241, 241, 0.98) !important;
        --secondary-text-color: #aab1bb !important;
        --card-background: #222222 !important;
        --border-color: #2b2b2b !important;
        <% } %>
        }
        <% if (personalization && personalization['theme.mode'] === 'dark') { %>
        .menu-link img {
            filter: brightness(0) invert(1)!important;
        }
        <% } %>
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <%- include('navbar') %>

            <div class="main">
                <div class="header-section">
                    <h1>
                        <i class="fas fa-chart-line me-2 header-icon"></i>
                        Dashboard de Administración
                    </h1>
                    <p>Panel de métricas y notificaciones en tiempo real</p>
                </div>

                <!-- Filtros -->
                <div class="container mt-4">
                    <div class="dashboard-filter-section dashboard-animate-on-load" style="animation-delay: 50ms;">
                        <div class="row justify-content-center align-items-center g-3">
                            <!-- Filtro Rango Fecha -->
                            <div class="col-auto">
                                <div class="dropdown">
                                    <button class="btn btn-primary dropdown-toggle" type="button"
                                            data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                                        <i class="fas fa-calendar-alt me-2"></i>Rango fecha
                                    </button>
                                    <div class="dropdown-menu">
                                        <div class="mb-3">
                                            <label for="fechaInicioFiltro" class="form-label">
                                                <div class="nombre"> Desde </div>
                                            </label>
                                            <input type="date" class="form-control" id="fechaInicioFiltro" name="fecha_inicio">
                                        </div>
                                        <div class="mb-1">
                                            <label for="fechaFinFiltro" class="form-label">
                                                <div class="nombre"> Hasta </div>
                                            </label>
                                            <input type="date" class="form-control" id="fechaFinFiltro" name="fecha_fin">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Filtro Especialidades -->
                            <div class="col-auto">
                                <div class="dropdown">
                                    <button class="btn btn-primary dropdown-toggle" type="button"
                                            data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                                        <i class="fas fa-stethoscope me-2"></i>Especialidades
                                    </button>
                                    <ul class="dropdown-menu" style="min-width: 260px;">
                                        <li>
                                            <div class="form-check title dropdown-item">
                                                <input class="form-check-input" type="checkbox" id="selectAllEspecialidades">
                                                <span class="form-check-label fw-bold">Seleccionar Todo</span>
                                            </div>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <div id="especialidades-list"></div>
                                    </ul>
                                </div>
                            </div>

                            <!-- Filtro Boxes -->
                            <div class="col-auto">
                                <div class="dropdown">
                                    <button class="btn btn-primary dropdown-toggle" type="button"
                                            data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                                        <i class="fas fa-door-open me-2"></i>Boxes
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-scrollable p-0">
                                        <li class="dropdown-header-fixed p-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="selectAllBoxes">
                                                <span class="form-check-label fw-bold">Seleccionar Todo</span>
                                            </div>
                                            <hr class="dropdown-divider mt-2 mb-0">
                                        </li>
                                        <div class="dropdown-scrollable-content px-3 pb-3">
                                            <div id="boxes-list"></div>
                                        </div>
                                    </ul>
                                </div>
                            </div>

                            <!-- Botón Resetear -->
                            <div class="col-auto">
                                <button type="button" id="resetearFiltros" class="btn btn-outline-primary">
                                    <i class="fas fa-refresh me-2"></i>Resetear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPIs -->
                <div class="dashboard-section-title-container dashboard-animate-on-load" style="animation-delay: 100ms;">
                    <h2 class="dashboard-section-title">Indicadores Clave</h2>
                </div>
                
                <div class="row gy-4 dashboard-kpi-container">
                    <div class="col-12 col-md-6 col-lg-3">
                        <div class="dashboard-kpi-card">
                            <div class="dashboard-kpi-title"><i class="fas fa-chart-pie me-2"></i>Ocupación de boxes</div>
                            <div class="dashboard-kpi-percentage" id="ocupacion-actual">--</div>
                            <div class="dashboard-kpi-subtext" id="ocupacion-subtext">Cargando datos...</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-3">
                        <div class="dashboard-kpi-card">
                            <div class="dashboard-kpi-title"><i class="fas fa-clipboard-list me-2"></i>Total de consultas</div>
                            <div class="dashboard-kpi-percentage" id="total-consultas">--</div>
                            <div class="dashboard-kpi-subtext" id="consultas-subtext">Cargando datos...</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-3">
                        <div class="dashboard-kpi-card">
                            <div class="dashboard-kpi-title"><i class="fas fa-chart-line me-2"></i>Promedio diario</div>
                            <div class="dashboard-kpi-percentage" id="promedio-consultas-diario">--</div>
                            <div class="dashboard-kpi-subtext" id="promedio-subtext">Cargando datos...</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-3">
                        <div class="dashboard-kpi-card">
                            <div class="dashboard-kpi-title"><i class="fas fa-trophy me-2"></i>Especialidad más demandada</div>
                            <div class="dashboard-kpi-percentage" id="especialidad-demandada">--</div>
                            <div class="dashboard-kpi-subtext" id="especialidad-subtext">Cargando datos...</div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="dashboard-section-title-container dashboard-animate-on-load" style="animation-delay: 400ms;">
                    <h2 class="dashboard-section-title">Análisis Visual</h2>
                </div>

                <div class="dashboard-visualization-row">
                    <div class="row gy-4 compact-chart-row">
                        <div class="col-12 col-sm-6 col-lg-6 col-xl-4">
                            <div class="dashboard-chart-container-card">
                                <div class="dashboard-chart-title"><i class="fas fa-chart-bar me-2"></i>Consultas por Especialidad</div>
                                <canvas id="consultasEspecialidadChart"></canvas>
                                <div id="consultasEspecialidadPlaceholder" class="dashboard-chart-container-placeholder">
                                    <i class="fas fa-chart-bar"></i><p><strong>No hay datos</strong></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-sm-6 col-lg-6 col-xl-4">
                            <div class="dashboard-chart-container-card">
                                <div class="dashboard-chart-title"><i class="fas fa-calendar-week me-2"></i>Consultas por día</div>
                                <canvas id="consultasPorDiaChart"></canvas>
                                <div id="consultasPorDiaPlaceholder" class="dashboard-chart-container-placeholder">
                                    <i class="fas fa-calendar-week"></i><p><strong>No hay datos</strong></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-sm-12 col-lg-12 col-xl-4">
                            <div class="dashboard-chart-container-card">
                                <div class="dashboard-chart-title"><i class="fas fa-user-md me-2"></i>Rendimiento de médicos</div>
                                <canvas id="rendimientoMedicosChart"></canvas>
                                <div id="rendimientoMedicosPlaceholder" class="dashboard-chart-container-placeholder">
                                    <i class="fas fa-user-md"></i><p><strong>No hay datos</strong></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <%- include('footer') %>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/dashboard.js"></script>
    <script>
        window.userPersonalization = <%- JSON.stringify(personalization || {}) %>;
    </script>
</body>
</html>