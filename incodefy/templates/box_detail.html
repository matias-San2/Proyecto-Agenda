<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>Detalle Box</title>
        {% load static %}
        <link rel="stylesheet" href="{% static 'css/sidebar.css' %}?v={% now 'U' %}">
        <link rel="stylesheet" href="{% static 'css/box_detail.css' %}?v={% now 'U' %}">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    </head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="mobile-header">
                <button class="toggle-sidebar" onclick="toggleSidebar()">☰ Menú</button>
            </div>
            <div class="col-2 d-none d-md-block" id="sidebar-container">
                {% include 'sidebar.html' %}    
            </div>

            <div class="main col-lg-10 col-sm-12 col-12" id="main-content">

                <div class="top-header">
                    <h2>Detalle del Box {{box_id}}</h2>
                </div>

                <div class="content-wrapper row justify-content-center">

                    <div class="info-box col-lg-9 col-md-10 col-11">
                        <div>Nombre: {{nombre}}</div>
                        <div>Pasillo: {{idpasillo}}</div>
                        <div>Estado: {{estado}}</div>
                    </div>

                    <div class="fecha-selector col-lg-9 col-md-10 col-11">
                        <button onclick="cambiarFecha(-1)">&lt;</button>
                        <span id="fechaLabel"></span>
                        <button onclick="cambiarFecha(1)">&gt;</button>
                    </div>
                    
                    <div class="row g-4 mt-3 info-panel">
                        <div class="col-lg-3 col-md-4 col-12">
                            <div class="horario-box">
                                <table class="table table-bordered text-center align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Hora</th>
                                            <th>Médico</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaHorarios"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="col-lg-8 col-md-7 col-12">
                            <div class="row g-4">
                                <div class="col-md-6 col-12">
                                    <div class="mb-3 metrica">Cantidad de consultas: <span id="totalConsultas"></span></div>
                                    <div class="mb-3 metrica">Uso de Box: <span id="usoBox"></span></div>
                                    <div class="chart-container mx-auto">
                                        <canvas id="graficoUso"></canvas>
                                    </div>
                                </div>

                                <div class="col-md-6 col-12">
                                    <div class="mb-3 metrica">Consultas no realizadas: <span id="noRealizadas"></span></div>
                                    <div class="mb-3 metrica">Cumplimiento: <span id="cumplimiento"></span></div>
                                    <div class="chart-container mx-auto">
                                        <canvas id="graficoCumplimiento"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let fechaActual;
        let chartUso, chartCumplimiento;

        function inicializarFecha() {
            const urlParams = new URLSearchParams(window.location.search);
            const fechaURL = urlParams.get("fecha");

            if (fechaURL) {
                fechaActual = new Date(fechaURL);
            } else {
                fechaActual = new Date();
                const nuevaURL = new URL(window.location);
                nuevaURL.searchParams.set("fecha", fechaActual.toISOString().split("T")[0]);
                window.history.replaceState({}, "", nuevaURL);
            }
        }

        function cambiarFecha(offsetDias) {
            fechaActual.setDate(fechaActual.getDate() + offsetDias);
            const nuevaFecha = fechaActual.toISOString().split("T")[0];

            const nuevaURL = new URL(window.location);
            nuevaURL.searchParams.set("fecha", nuevaFecha);
            window.history.pushState({}, "", nuevaURL);

            cargarDatosBox();
        }

        function cargarDatosBox() {
            const boxId = "{{ box_id }}";
            const fechaParam = fechaActual.toISOString().split("T")[0];

            fetch(`/obtener-info-box/?box_id=${boxId}&fecha=${fechaParam}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById("fechaLabel").textContent = data.fecha;
                    document.getElementById("totalConsultas").textContent = data.total_consultas;
                    document.getElementById("noRealizadas").textContent = data.consultas_no_realizadas;
                    document.getElementById("usoBox").textContent = data.uso_box + "%";
                    document.getElementById("cumplimiento").textContent = data.cumplimiento + "%";

                    const tabla = document.getElementById("tablaHorarios");
                    tabla.innerHTML = "";
                    for (const [hora, medico] of Object.entries(data.horarios)) {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${hora}</td>
                            <td>${medico ? `<div class="celda">${medico}</div>` : ""}</td>
                        `;
                        tabla.appendChild(row);
                    }

                    actualizarGraficos(data.uso_box, data.cumplimiento);
                })
                .catch(error => {
                    console.error("Error al cargar datos del box:", error);
                });
        }

        function actualizarGraficos(uso, cumplimiento) {
            if (chartUso) chartUso.destroy();
            if (chartCumplimiento) chartCumplimiento.destroy();

            const chartConfig = {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${Math.round(context.raw)}%`;
                            }
                        }
                    }
                }
            };

            chartUso = new Chart(document.getElementById("graficoUso"), {
                type: 'doughnut',
                data: {
                    labels: ['Usado', 'Libre'],
                    datasets: [{
                        data: [uso, 100 - uso],
                        backgroundColor: ['#3498db', '#ecf0f1'],
                        borderColor: ['#2980b9', '#bdc3c7'],
                        borderWidth: 1
                    }]
                },
                options: {
                    ...chartConfig,
                    plugins: {
                        ...chartConfig.plugins,
                        title: { 
                            display: true, 
                            text: 'Uso del Box',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                bottom: 10
                            }
                        }
                    }
                }
            });

            chartCumplimiento = new Chart(document.getElementById("graficoCumplimiento"), {
                type: 'doughnut',
                data: {
                    labels: ['Cumplido', 'Incumplido'],
                    datasets: [{
                        data: [cumplimiento, 100 - cumplimiento],
                        backgroundColor: ['#2ecc71', '#ecf0f1'],
                        borderColor: ['#27ae60', '#bdc3c7'],
                        borderWidth: 1
                    }]
                },
                options: {
                    ...chartConfig,
                    plugins: {
                        ...chartConfig.plugins,
                        title: { 
                            display: true, 
                            text: 'Cumplimiento',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                bottom: 10
                            }
                        }
                    }
                }
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            inicializarFecha();
            cargarDatosBox();
            
            window.addEventListener('resize', () => {
                if (chartUso && chartCumplimiento) {
                    chartUso.resize();
                    chartCumplimiento.resize();
                }
            });
        });

        function toggleSidebar() {
            const sidebar = document.getElementById("sidebar");
            const container = document.getElementById("sidebar-container");

            sidebar.classList.toggle("show");

            if (sidebar.classList.contains("show")) {
                container.style.display = "block";
            } else {
                container.style.display = "none";
            }
        }

    </script>
</body>
</html>
