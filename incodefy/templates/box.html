<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>Box de Pasillos</title>
        {% load static %}
        <link rel="stylesheet" href="{% static 'css/sidebar.css' %}?v={% now 'U' %}">
        <link rel="stylesheet" href="{% static 'css/box.css' %}?v={% now 'U' %}">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    </head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="mobile-header">
                <button class="toggle-sidebar" onclick="toggleSidebar()">☰ Menú</button>
            </div>
            <div class="col-2 d-none d-md-block" id="sidebar-container">
                {% include 'sidebar.html' %}    
            </div>
            <div class="main col-lg-10 col-sm-12 col-12" id="main-content">
                <div class="top-header">
                    <div class="header-row center-header">
                        <h1>Pasillos y Boxes</h1>
                    </div>
                    <div class="reloj-wrapper">
                        <div id="reloj" class="reloj"></div>
                    </div>
                </div>
                
                <div class="filtros">
                    <div class="filtros-inputs">
                        <input type="text" id="filtroPasillo" placeholder="Filtrar por número de pasillo">
                        <input type="text" id="filtroBox" placeholder="Filtrar por número de box">
                        <select id="filtroEstado">
                            <option value="">Mostrar todos</option>
                            <option value="en-uso">En uso</option>
                            <option value="libre">Libre</option>
                            <option value="inhabilitado">Inhabilitado</option>
                        </select>
                    </div>
                    <div class="filtros-botones">
                        <button onclick="aplicarFiltros()">Aplicar filtros</button>
                        <button onclick="reiniciarFiltros()">Reiniciar filtros</button>
                    </div>
                </div>

                {% for pasillo, boxes in pasillo_box_map.items %}
                <div class="pasillo-bloque col-11 mx-auto">
                    <div class="pasillo-nombre">{{ pasillo.nombre }}</div>
                    <div class="pasillo-content row">
                        {% for box in boxes %}
                        <div class="col-lg-3 col-md-4 col-sm-6 col-6 d-flex box-wrapper">
                            <a href="{% url 'box_detail' box.id %}" class="box-card w-100">
                                <h3>Box {{ box.id }}</h3>
                                <div id="info-box-{{ box.id }}" class="info-box">
                                    <div class="contenido-box">
                                        <p>Próxima consulta: No hay próxima consulta hoy</p>
                                    </div>
                                    <div class="estado-bar libre">Libre</div>
                                </div>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>       
        </div>    
    </div>

    <script>
        function actualizarReloj() {
            const reloj = document.getElementById("reloj");
            const ahora = new Date();
            const horas = String(ahora.getHours()).padStart(2, '0');
            const minutos = String(ahora.getMinutes()).padStart(2, '0');
            const segundos = String(ahora.getSeconds()).padStart(2, '0');
            reloj.innerText = `${horas} : ${minutos} : ${segundos}`;
        }

        setInterval(actualizarReloj, 1000);
        actualizarReloj();

        function actualizarBoxes() {
            fetch('/estado_boxes/')
            .then(response => response.json())
            .then(data => {
                for (const [id, info] of Object.entries(data)) {
                    const contenedor = document.getElementById(`info-box-${id}`);
                    if (contenedor) {
                        contenedor.innerHTML = `
                            <div class="contenido-box">
                                ${info.proxima_consulta ? `<p>Próxima consulta: ${info.proxima_consulta}</p>` : ''}
                                ${info.consulta_actual ? `<p>Hora inicio: ${info.consulta_actual}</p>` : ''}
                                ${info.medico ? `<p>Doctor: ${info.medico}</p>` : ''}
                                ${info.especialidad ? `<p>Especialidad: ${info.especialidad}</p>` : ''}
                            </div>
                            <div class="estado-bar ${info.estado.replace(' ', '-').toLowerCase()}">${info.estado}</div>
                        `;

                    }
                }
            })
            .catch(error => {
                console.error("Error al obtener estados:", error);
            });
        }

        function aplicarFiltros() {
            const pasillo = document.getElementById("filtroPasillo").value.trim();
            const box = document.getElementById("filtroBox").value.trim();
            const estado = document.getElementById("filtroEstado").value.trim();

            const params = new URLSearchParams();
            if (pasillo) params.append("pasillo", pasillo);
            if (box) params.append("box", box);
            if (estado) params.append("estado", estado);

            window.location.href = `/box/?${params.toString()}`;
        }

        function reiniciarFiltros() {
            document.getElementById("filtroPasillo").value = "";
            document.getElementById("filtroBox").value = "";
            document.getElementById("filtroEstado").value = "";
            aplicarFiltros();
        }

        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            document.getElementById("filtroPasillo").value = params.get("pasillo") || '';
            document.getElementById("filtroBox").value = params.get("box") || '';
            document.getElementById("filtroEstado").value = params.get("estado") || '';
        });

        actualizarBoxes();

        

        const socket = new WebSocket('ws://' + window.location.host + '/ws/estado-box/');

        socket.onopen = function(e) {
            console.log("WebSocket conectado correctamente");
        };

        socket.onmessage = function(e) {
            try {
                const data = JSON.parse(e.data);
                console.log("Cambio detectado en Agenda:", data);

                if (data.trigger === 'cambio_en_agenda') {
                    actualizarBoxes();
                }
            } catch (error) {
                console.error("Error al procesar mensaje:", error, e.data);
            }
        };

        socket.onerror = function(e) {
            console.error("Error en WebSocket:", e);
        };

        socket.onclose = function(e) {
            console.warn("WebSocket cerrado. Código:", e.code, "Razón:", e.reason);
        };


        function toggleSidebar() {
            const sidebar = document.getElementById("sidebar");
            const container = document.getElementById("sidebar-container");

            sidebar.classList.toggle("show");

            if (sidebar.classList.contains("show")) {
                container.style.display = "block";
            } else {
                container.style.display = "none";
            }
        }

    </script>    
</body>
</html>
